<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Fracci√≥n Quest - Aventura Espacial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        space: '#0B1426',
                        rocket: '#FF6B35',
                        star: '#FFD700',
                    },
                    animation: {
                        'pop': 'pop 0.5s ease-out',
                        'confetti': 'confetti 0.8s ease-out',
                        'float': 'float 3s ease-in-out infinite',
                        'rocket-move': 'rocket-move 2s ease-in-out infinite',
                        'twinkle': 'twinkle 2s ease-in-out infinite',
                        'planet-rotate': 'planet-rotate 20s linear infinite',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.8)' },
                            '50%': { transform: 'scale(1.1)' },
                            '100%': { transform: 'scale(1)' },
                        },
                        confetti: {
                            '0%': { transform: 'translateY(0) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'translateY(-20px) rotate(360deg)', opacity: '0' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'rocket-move': {
                            '0%, 100%': { transform: 'translateX(0px) rotate(0deg)' },
                            '50%': { transform: 'translateX(10px) rotate(5deg)' },
                        },
                        twinkle: {
                            '0%, 100%': { opacity: '0.3', transform: 'scale(1)' },
                            '50%': { opacity: '1', transform: 'scale(1.2)' },
                        },
                        'planet-rotate': {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
        }
        .fraction .numerator {
            display: block;
            border-bottom: 2px solid #333;
            padding-bottom: 2px;
        }
        .fraction .denominator {
            display: block;
            padding-top: 2px;
        }
        .dark .fraction .numerator {
            border-bottom-color: #fff;
        }
        .glow {
            box-shadow: 0 0 20px rgba(93, 92, 222, 0.5);
        }
        .space-glow {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            animation: confetti 2s ease-out infinite;
        }
        .lesson-card:hover {
            transform: translateY(-5px);
        }
        .space-bg {
            background: linear-gradient(135deg, #0B1426 0%, #1a202c 50%, #2d3748 100%);
            position: relative;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s ease-in-out infinite;
        }
        .star-1 { width: 2px; height: 2px; top: 10%; left: 10%; animation-delay: 0s; }
        .star-2 { width: 3px; height: 3px; top: 20%; left: 80%; animation-delay: 0.5s; }
        .star-3 { width: 2px; height: 2px; top: 40%; left: 15%; animation-delay: 1s; }
        .star-4 { width: 4px; height: 4px; top: 60%; left: 70%; animation-delay: 1.5s; }
        .star-5 { width: 2px; height: 2px; top: 80%; left: 30%; animation-delay: 2s; }
        .star-6 { width: 3px; height: 3px; top: 15%; left: 50%; animation-delay: 0.3s; }
        .mission-complete {
            background: linear-gradient(45deg, #10b981, #34d399);
            animation: pop 0.6s ease-out;
        }
        .mission-locked {
            opacity: 0.6;
            filter: grayscale(100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 to-blue-100 dark:from-gray-900 dark:to-purple-900 text-gray-900 dark:text-white min-h-screen">
    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-2xl glow mb-4">
                <h1 class="text-5xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2">
                    üéÆ Fracci√≥n Quest
                </h1>
                <p class="text-xl text-gray-600 dark:text-gray-300 mb-4">¬°Convi√©rtete en el Maestro de las Fracciones!</p>
                
                <!-- Player Stats -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-6">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-4 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-bold">Nivel</span>
                            <span id="player-level" class="text-2xl font-bold bg-white text-purple-600 px-3 py-1 rounded-full">1</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-3 mb-2">
                            <div id="xp-bar" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="text-xs">
                            XP: <span id="current-xp">0</span> / <span id="max-xp">100</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-4 text-white">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1">üèÜ</div>
                            <div id="total-points" class="text-2xl font-bold">0</div>
                            <div class="text-xs">Puntos</div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl p-4 text-white">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1">üî•</div>
                            <div id="streak-count" class="text-2xl font-bold">0</div>
                            <div class="text-xs">Racha</div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-indigo-500 to-cyan-500 rounded-2xl p-4 text-white">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1">üöÄ</div>
                            <div id="space-missions" class="text-2xl font-bold">0</div>
                            <div class="text-xs">Misiones</div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-teal-500 rounded-2xl p-4 text-white">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1">üéñÔ∏è</div>
                            <div id="achievement-count" class="text-2xl font-bold">0</div>
                            <div class="text-xs">Logros</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="mb-8">
            <div class="flex flex-wrap justify-center gap-3 mb-4">
                <button onclick="showSection('tutorial')" class="nav-btn bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-2xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    üéì Tutorial
                </button>
                <button onclick="showSection('space')" class="nav-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    üöÄ Aventura Espacial
                </button>
                <button onclick="showSection('challenge')" class="nav-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    ‚ö° Desaf√≠o R√°pido
                </button>
                <button onclick="showSection('practice')" class="nav-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    üèãÔ∏è Pr√°ctica Libre
                </button>
                <button onclick="showSection('visual')" class="nav-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    üëÅÔ∏è Visualizador
                </button>
            </div>
        </nav>

        <!-- Tutorial Section -->
        <section id="tutorial" class="section">
            <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 shadow-2xl mb-6 glow">
                <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                    üéì Academia de Fracciones
                </h2>
                
                <!-- Lesson Selection -->
                <div id="lesson-selection" class="grid lg:grid-cols-3 gap-6">
                    <div onclick="showLessonDetail('basics')" class="lesson-card bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900 dark:to-purple-900 p-6 rounded-2xl cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <div class="text-4xl mb-3">üìö</div>
                        <h3 class="text-xl font-bold mb-2">Conceptos B√°sicos</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Aprende qu√© son las fracciones y sus tipos</p>
                        <div class="mt-4 text-green-600 font-bold">+50 XP</div>
                    </div>
                    
                    <div onclick="showLessonDetail('addition')" class="lesson-card bg-gradient-to-br from-yellow-100 to-orange-100 dark:from-yellow-900 dark:to-orange-900 p-6 rounded-2xl cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <div class="text-4xl mb-3">‚ûï</div>
                        <h3 class="text-xl font-bold mb-2">Suma y Resta</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Domina las operaciones b√°sicas</p>
                        <div class="mt-4 text-green-600 font-bold">+75 XP</div>
                    </div>
                    
                    <div onclick="showLessonDetail('multiply')" class="lesson-card bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 p-6 rounded-2xl cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <div class="text-4xl mb-3">‚úñÔ∏è</div>
                        <h3 class="text-xl font-bold mb-2">Multiplicaci√≥n y Divisi√≥n</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">Operaciones avanzadas</p>
                        <div class="mt-4 text-green-600 font-bold">+100 XP</div>
                    </div>
                </div>
                
                <!-- Lesson Detail Content -->
                <div id="lesson-detail" class="mt-8 hidden">
                    <button onclick="backToLessons()" class="mb-4 bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 transition-colors">
                        ‚Üê Volver a Lecciones
                    </button>
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-2xl p-6">
                        <div id="lesson-content-display"></div>
                        <div class="text-center mt-6">
                            <button onclick="completeLessonDirect()" id="complete-lesson-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105">
                                Completar Lecci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Space Adventure Section -->
        <section id="space" class="section hidden">
            <div class="space-bg rounded-3xl p-8 shadow-2xl mb-6 space-glow relative">
                <!-- Stars Background -->
                <div class="star star-1"></div>
                <div class="star star-2"></div>
                <div class="star star-3"></div>
                <div class="star star-4"></div>
                <div class="star star-5"></div>
                <div class="star star-6"></div>
                
                <h2 class="text-3xl font-bold mb-6 text-center text-white relative z-10">
                    üöÄ Aventura Espacial: Misiones Fraccionarias
                </h2>
                
                <!-- Space Mission Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 relative z-10">
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-2xl p-4 text-white backdrop-blur-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üåå</div>
                            <div id="current-galaxy" class="text-xl font-bold">Galaxia Alpha</div>
                            <div class="text-sm">Galaxia Actual</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-4 text-white backdrop-blur-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üõ∏</div>
                            <div id="ship-level" class="text-xl font-bold">Nave Nivel 1</div>
                            <div class="text-sm">Tu Nave</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-4 text-white backdrop-blur-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">‚ö°</div>
                            <div id="energy-level" class="text-xl font-bold">100%</div>
                            <div class="text-sm">Energ√≠a</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-2xl p-4 text-white backdrop-blur-sm">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üí´</div>
                            <div id="crystals-collected" class="text-xl font-bold">0</div>
                            <div class="text-sm">Cristales</div>
                        </div>
                    </div>
                </div>

                <!-- Mission Selection -->
                <div id="mission-selection" class="relative z-10">
                    <h3 class="text-2xl font-bold text-white mb-6 text-center">üéØ Selecciona tu Misi√≥n</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Mission 1: Basic Operations -->
                        <div onclick="startSpaceMission('basic')" class="mission-card bg-gradient-to-br from-green-400 to-blue-500 p-6 rounded-2xl cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-2xl text-white">
                            <div class="text-center">
                                <div class="text-4xl mb-3 animate-float">ü™ê</div>
                                <h4 class="text-xl font-bold mb-2">Planeta B√°sico</h4>
                                <p class="text-sm mb-4">Operaciones b√°sicas de fracciones</p>
                                <div class="text-lg font-bold">+50 Cristales ‚≠ê</div>
                                <div class="text-sm mt-2">Dificultad: F√°cil</div>
                            </div>
                        </div>

                        <!-- Mission 2: Advanced Operations -->
                        <div onclick="startSpaceMission('advanced')" class="mission-card bg-gradient-to-br from-orange-400 to-red-500 p-6 rounded-2xl cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-2xl text-white">
                            <div class="text-center">
                                <div class="text-4xl mb-3 animate-float" style="animation-delay: 0.5s">üåü</div>
                                <h4 class="text-xl font-bold mb-2">Estrella Dorada</h4>
                                <p class="text-sm mb-4">Operaciones avanzadas y mixtas</p>
                                <div class="text-lg font-bold">+100 Cristales ‚≠ê‚≠ê</div>
                                <div class="text-sm mt-2">Dificultad: Media</div>
                            </div>
                        </div>

                        <!-- Mission 3: Master Challenge -->
                        <div onclick="startSpaceMission('master')" class="mission-card bg-gradient-to-br from-purple-500 to-indigo-600 p-6 rounded-2xl cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-2xl text-white">
                            <div class="text-center">
                                <div class="text-4xl mb-3 animate-float" style="animation-delay: 1s">üåå</div>
                                <h4 class="text-xl font-bold mb-2">Agujero Negro</h4>
                                <p class="text-sm mb-4">Desaf√≠o m√°ximo de fracciones</p>
                                <div class="text-lg font-bold">+200 Cristales ‚≠ê‚≠ê‚≠ê</div>
                                <div class="text-sm mt-2">Dificultad: Experto</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mission Interface -->
                <div id="mission-interface" class="mt-8 hidden relative z-10">
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 text-white">
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="mission-title" class="text-2xl font-bold">üöÄ Misi√≥n en Progreso</h3>
                            <button onclick="exitMission()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-xl transition-colors">
                                üö™ Salir
                            </button>
                        </div>

                        <!-- Mission Progress -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-500/20 rounded-xl p-4 text-center">
                                <div class="text-xl font-bold" id="mission-progress">0/5</div>
                                <div class="text-sm">Problemas Resueltos</div>
                            </div>
                            <div class="bg-green-500/20 rounded-xl p-4 text-center">
                                <div class="text-xl font-bold" id="mission-score">0</div>
                                <div class="text-sm">Puntuaci√≥n</div>
                            </div>
                            <div class="bg-purple-500/20 rounded-xl p-4 text-center">
                                <div class="text-xl font-bold" id="mission-time">60</div>
                                <div class="text-sm">Tiempo (s)</div>
                            </div>
                        </div>

                        <!-- Problem Display -->
                        <div id="space-problem" class="bg-black/30 rounded-xl p-8 mb-6">
                            <div class="text-center">
                                <div class="text-6xl mb-4 animate-rocket-move">üöÄ</div>
                                <h4 class="text-xl mb-4">üõ∏ Mensaje de la nave:</h4>
                                <div id="problem-display" class="text-3xl mb-6 font-bold">
                                    <!-- Problem will be displayed here -->
                                </div>
                                <div id="space-options" class="grid grid-cols-2 gap-4">
                                    <!-- Options will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Mission Results -->
                        <div id="mission-results" class="hidden bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-6 text-center text-black">
                            <h4 class="text-2xl font-bold mb-4">üéâ ¬°Misi√≥n Completada!</h4>
                            <div id="mission-summary" class="text-lg">
                                <!-- Results will be displayed here -->
                            </div>
                            <button onclick="returnToMissions()" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors">
                                üöÄ Nuevas Misiones
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Challenge Section -->
        <section id="challenge" class="section hidden">
            <div class="bg-gradient-to-br from-orange-100 to-red-100 dark:from-orange-900/30 dark:to-red-900/30 rounded-3xl p-8 shadow-2xl mb-6 space-glow">
                <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">
                    ‚ö° Desaf√≠o R√°pido: Operaciones Combinadas
                </h2>
                
                <!-- Challenge Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="challenge-score">0</div>
                        <div class="text-sm">Puntuaci√≥n</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="challenge-correct">0</div>
                        <div class="text-sm">Correctas</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="challenge-streak">0</div>
                        <div class="text-sm">Racha</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="challenge-time">60</div>
                        <div class="text-sm">Tiempo (s)</div>
                    </div>
                </div>

                <!-- Challenge Controls -->
                <div id="challenge-start" class="text-center">
                    <div class="bg-white/70 dark:bg-gray-800/70 p-8 rounded-2xl mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-orange-600">üî• ¬°Ponte a Prueba!</h3>
                        <p class="text-lg mb-6">Resuelve 5 ejercicios combinados que mezclan todas las operaciones con fracciones.</p>
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-r from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 p-4 rounded-xl">
                                <div class="text-3xl mb-2">üßÆ</div>
                                <h4 class="font-bold">Operaciones Mixtas</h4>
                                <p class="text-sm">Suma, resta, multiplicaci√≥n y divisi√≥n juntas</p>
                            </div>
                            <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-xl">
                                <div class="text-3xl mb-2">‚è±Ô∏è</div>
                                <h4 class="font-bold">Tiempo Limitado</h4>
                                <p class="text-sm">120 segundos para cada problema</p>
                            </div>
                            <div class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-xl">
                                <div class="text-3xl mb-2">üèÜ</div>
                                <h4 class="font-bold">Puntuaci√≥n Extra</h4>
                                <p class="text-sm">+200 XP por desaf√≠o completado</p>
                            </div>
                        </div>
                        <button onclick="startChallenge()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white text-xl px-8 py-4 rounded-2xl hover:from-orange-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg">
                            üöÄ ¬°Comenzar Desaf√≠o!
                        </button>
                    </div>
                </div>

                <!-- Challenge Interface -->
                <div id="challenge-interface" class="hidden">
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold">Progreso:</span>
                            <span id="challenge-progress" class="text-sm font-bold">1/5</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="challenge-progress-bar" class="bg-gradient-to-r from-orange-500 to-red-600 h-4 rounded-full transition-all duration-500" style="width: 20%"></div>
                        </div>
                    </div>

                    <!-- Problem Display -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 mb-6 text-center">
                        <div class="text-4xl mb-4" id="challenge-emoji">üßÆ</div>
                        <h3 class="text-xl font-bold mb-4" id="challenge-question-title">Problema 1</h3>
                        <div id="challenge-problem" class="text-4xl mb-6 font-bold text-orange-600">
                            <!-- Problem will be displayed here -->
                        </div>
                        <div id="challenge-options" class="grid grid-cols-2 gap-4">
                            <!-- Options will be displayed here -->
                        </div>
                    </div>

                    <!-- Hint System -->
                    <div id="challenge-hint" class="bg-yellow-100 dark:bg-yellow-900/30 rounded-xl p-4 mb-4 hidden">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üí°</span>
                            <div>
                                <h4 class="font-bold">Pista:</h4>
                                <p class="text-sm" id="challenge-hint-text"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Challenge Controls -->
                    <div class="flex justify-center gap-4">
                        <button onclick="showHint()" id="hint-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600 transition-colors">
                            üí° Pista
                        </button>
                        <button onclick="exitChallenge()" class="bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 transition-colors">
                            üö™ Salir
                        </button>
                    </div>
                </div>

                <!-- Challenge Results -->
                <div id="challenge-results" class="hidden">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-8 text-center text-black">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-3xl font-bold mb-4">¬°Desaf√≠o Completado!</h3>
                        <div id="challenge-final-stats" class="text-lg mb-6">
                            <!-- Final stats will be displayed here -->
                        </div>
                        <div class="flex justify-center gap-4">
                            <button onclick="startChallenge()" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors">
                                üîÑ Intentar de Nuevo
                            </button>
                            <button onclick="exitChallenge()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors">
                                ‚úÖ Continuar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Practice Section -->
        <section id="practice" class="section hidden">
            <div class="bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 rounded-3xl p-8 shadow-2xl mb-6 space-glow">
                <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    üèãÔ∏è Pr√°ctica Libre: Ejercicios Mixtos
                </h2>
                
                <!-- Practice Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="practice-completed">0</div>
                        <div class="text-sm">Completados</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="practice-correct">0</div>
                        <div class="text-sm">Correctos</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="practice-accuracy">0%</div>
                        <div class="text-sm">Precisi√≥n</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl p-4 text-white text-center">
                        <div class="text-2xl font-bold mb-1" id="practice-xp">0</div>
                        <div class="text-sm">XP Ganado</div>
                    </div>
                </div>

                <!-- Mode Selection -->
                <div id="practice-mode-selection" class="text-center mb-8">
                    <div class="bg-white/70 dark:bg-gray-800/70 p-8 rounded-2xl mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-blue-600">üìö Elige tu Modalidad de Pr√°ctica</h3>
                        <p class="text-lg mb-6">10 ejercicios mixtos para dominar todas las operaciones con fracciones</p>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 p-6 rounded-xl">
                                <div class="text-4xl mb-3">üíª</div>
                                <h4 class="text-xl font-bold mb-2">Pr√°ctica Digital</h4>
                                <p class="text-sm mb-4">Resuelve los ejercicios en pantalla con feedback inmediato</p>
                                <button onclick="startDigitalPractice()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105">
                                    üöÄ Comenzar Digital
                                </button>
                            </div>
                            
                            <div class="bg-gradient-to-r from-orange-100 to-red-100 dark:from-orange-900/30 dark:to-red-900/30 p-6 rounded-xl">
                                <div class="text-4xl mb-3">üìÑ</div>
                                <h4 class="text-xl font-bold mb-2">Hoja de Trabajo</h4>
                                <p class="text-sm mb-4">Genera una hoja PDF para imprimir y resolver en papel</p>
                                <button onclick="generateWorksheet()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-3 rounded-xl hover:from-orange-600 hover:to-red-700 transition-all transform hover:scale-105">
                                    üì• Generar Hoja
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl">
                            <h4 class="font-bold mb-2">üìã Tipos de Ejercicios Incluidos:</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <ul class="space-y-1">
                                    <li>‚Ä¢ ‚ûï Suma con denominadores diferentes</li>
                                    <li>‚Ä¢ ‚ûñ Resta con m√©todo mariposa</li>
                                    <li>‚Ä¢ ‚úñÔ∏è Multiplicaci√≥n directa</li>
                                    <li>‚Ä¢ ‚ûó Divisi√≥n (invertir y multiplicar)</li>
                                    <li>‚Ä¢ üî¢ Operaciones combinadas</li>
                                </ul>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ üìê Simplificaci√≥n de resultados</li>
                                    <li>‚Ä¢ üîÑ Conversi√≥n a n√∫meros mixtos</li>
                                    <li>‚Ä¢ üéØ Problemas de aplicaci√≥n</li>
                                    <li>‚Ä¢ üßÆ Orden de operaciones</li>
                                    <li>‚Ä¢ ‚≠ê Diferentes niveles de dificultad</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Digital Practice Interface -->
                <div id="digital-practice" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold">üíª Pr√°ctica Digital</h3>
                            <div class="flex gap-3">
                                <span id="practice-progress" class="bg-blue-100 dark:bg-blue-900 px-3 py-1 rounded-full text-sm font-bold">1/10</span>
                                <button onclick="exitPractice()" class="bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 transition-colors">
                                    üö™ Salir
                                </button>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="practice-progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full transition-all duration-500" style="width: 10%"></div>
                            </div>
                        </div>

                        <!-- Exercise Display -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-8 mb-6">
                            <div class="text-center">
                                <div class="text-2xl mb-4" id="practice-emoji">üìù</div>
                                <h4 class="text-lg font-bold mb-4" id="practice-title">Ejercicio 1</h4>
                                <div id="practice-exercise" class="text-3xl mb-6 font-bold text-blue-600">
                                    <!-- Exercise will be displayed here -->
                                </div>
                                
                                <!-- Answer Input -->
                                <div class="mb-6">
                                    <p class="text-sm mb-3">Ingresa tu respuesta:</p>
                                    <div class="flex justify-center items-center gap-2 mb-4">
                                        <input type="number" id="answer-numerator" class="w-20 px-3 py-2 text-center text-lg border-2 border-blue-300 rounded-lg focus:border-blue-500" placeholder="Num" min="0">
                                        <span class="text-2xl font-bold">/</span>
                                        <input type="number" id="answer-denominator" class="w-20 px-3 py-2 text-center text-lg border-2 border-blue-300 rounded-lg focus:border-blue-500" placeholder="Den" min="1">
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mb-4">
                                        (Si es un n√∫mero entero, coloca 1 en el denominador)
                                    </div>
                                    <button onclick="checkPracticeAnswer()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105">
                                        ‚úÖ Verificar Respuesta
                                    </button>
                                </div>

                                <!-- Hint System -->
                                <div id="practice-hint" class="bg-yellow-100 dark:bg-yellow-900/30 rounded-xl p-4 mb-4 hidden">
                                    <div class="flex items-start">
                                        <span class="text-2xl mr-3">üí°</span>
                                        <div class="text-left">
                                            <h5 class="font-bold">Pista:</h5>
                                            <p class="text-sm" id="practice-hint-text"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Result Display -->
                                <div id="practice-result" class="hidden">
                                    <div id="practice-feedback" class="text-lg font-bold mb-3">
                                        <!-- Feedback will be shown here -->
                                    </div>
                                    <div id="practice-explanation" class="text-sm text-left bg-white dark:bg-gray-700 p-4 rounded-lg">
                                        <!-- Explanation will be shown here -->
                                    </div>
                                    <button onclick="nextPracticeExercise()" class="mt-4 bg-blue-500 text-white px-6 py-3 rounded-xl hover:bg-blue-600 transition-colors">
                                        ‚û°Ô∏è Siguiente Ejercicio
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="flex justify-center gap-4">
                            <button onclick="showPracticeHint()" id="practice-hint-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600 transition-colors">
                                üí° Pista
                            </button>
                            <button onclick="skipExercise()" class="bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 transition-colors">
                                ‚è≠Ô∏è Saltar
                            </button>
                        </div>
                    </div>

                    <!-- Practice Complete -->
                    <div id="practice-complete" class="hidden bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl p-8 text-center text-white">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-3xl font-bold mb-4">¬°Pr√°ctica Completada!</h3>
                        <div id="practice-final-stats" class="text-lg mb-6">
                            <!-- Final stats will be displayed here -->
                        </div>
                        
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 mb-6">
                            <h4 class="text-xl font-bold mb-3">üéØ ¬øQu√© quieres hacer ahora?</h4>
                            <p class="text-sm mb-4">Contin√∫a tu aprendizaje eligiendo una de estas opciones:</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <button onclick="startDigitalPractice()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                                    <div class="flex items-center justify-center gap-2">
                                        <span class="text-xl">üîÑ</span>
                                        <span>Practicar de Nuevo</span>
                                    </div>
                                    <div class="text-xs mt-1 opacity-80">M√°s ejercicios digitales</div>
                                </button>
                                <button onclick="generateWorksheet()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                                    <div class="flex items-center justify-center gap-2">
                                        <span class="text-xl">üìÑ</span>
                                        <span>Hoja de Trabajo</span>
                                    </div>
                                    <div class="text-xs mt-1 opacity-80">Descargar para imprimir</div>
                                </button>
                            </div>
                            <button onclick="exitPractice()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-xl">‚úÖ</span>
                                    <span>Volver al Men√∫ Principal</span>
                                </div>
                                <div class="text-xs mt-1 opacity-80">Explorar otras secciones</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Worksheet Preview/Download -->
                <div id="worksheet-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold">üìÑ Hoja de Trabajo: Fracciones Mixtas</h3>
                            <button onclick="closeWorksheet()" class="bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 transition-colors">
                                ‚úñÔ∏è Cerrar
                            </button>
                        </div>
                        
                        <div class="flex justify-center gap-4 mb-6">
                            <button onclick="printWorksheet()" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors">
                                üñ®Ô∏è Imprimir
                            </button>
                            <button onclick="downloadWorksheet()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors">
                                üì• Descargar PDF
                            </button>
                            <button onclick="generateNewWorksheet()" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition-colors">
                                üîÑ Nueva Hoja
                            </button>
                        </div>

                        <div id="worksheet-content" class="bg-white p-8 border rounded-lg">
                            <!-- Worksheet content will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Visual Section -->
        <section id="visual" class="section hidden">
            <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 shadow-2xl mb-6">
                <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                    üëÅÔ∏è Visualizador Interactivo de Fracciones
                </h2>
                
                <!-- Tabs Navigation -->
                <div class="flex flex-wrap justify-center gap-3 mb-8">
                    <button onclick="showVisualTab('operations')" class="visual-tab-btn bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-6 py-3 rounded-2xl hover:from-blue-600 hover:to-cyan-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        üßÆ Operaciones Paso a Paso
                    </button>
                    <button onclick="showVisualTab('converter')" class="visual-tab-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        üîÑ Convertidor Universal
                    </button>
                    <button onclick="showVisualTab('generator')" class="visual-tab-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        üéõÔ∏è Generador Personalizado
                    </button>
                </div>

                <!-- Operations Tab -->
                <div id="operations-tab" class="visual-tab">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-2xl p-8">
                        <h3 class="text-2xl font-bold mb-6 text-center text-blue-600">üßÆ Visualiza las Operaciones Paso a Paso</h3>
                        
                        <!-- Operation Input -->
                        <div class="grid md:grid-cols-2 gap-8 mb-8">
                            <div class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                <h4 class="text-lg font-bold mb-4 text-center">üìù Crea tu Operaci√≥n</h4>
                                <div class="space-y-4">
                                    <!-- First Fraction -->
                                    <div class="flex justify-center items-center gap-2">
                                        <label class="text-sm font-bold">Primera fracci√≥n:</label>
                                        <input type="number" id="op-num1" class="w-16 px-2 py-1 text-center border rounded" value="1" min="1">
                                        <span class="text-xl">/</span>
                                        <input type="number" id="op-den1" class="w-16 px-2 py-1 text-center border rounded" value="2" min="1">
                                    </div>
                                    
                                    <!-- Operation -->
                                    <div class="flex justify-center">
                                        <select id="operation-type" class="px-4 py-2 border rounded-lg">
                                            <option value="add">‚ûï Suma</option>
                                            <option value="subtract">‚ûñ Resta</option>
                                            <option value="multiply">‚úñÔ∏è Multiplicaci√≥n</option>
                                            <option value="divide">‚ûó Divisi√≥n</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Second Fraction -->
                                    <div class="flex justify-center items-center gap-2">
                                        <label class="text-sm font-bold">Segunda fracci√≥n:</label>
                                        <input type="number" id="op-num2" class="w-16 px-2 py-1 text-center border rounded" value="1" min="1">
                                        <span class="text-xl">/</span>
                                        <input type="number" id="op-den2" class="w-16 px-2 py-1 text-center border rounded" value="3" min="1">
                                    </div>
                                    
                                    <button onclick="visualizeOperation()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105">
                                        ‚ú® Visualizar Operaci√≥n
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Visual Display -->
                            <div class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                <h4 class="text-lg font-bold mb-4 text-center">üëÅÔ∏è Representaci√≥n Visual</h4>
                                <div id="visual-display" class="min-h-64 flex items-center justify-center text-gray-500">
                                    Selecciona los n√∫meros y presiona "Visualizar Operaci√≥n"
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step by Step Solution -->
                        <div id="step-solution" class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-lg hidden">
                            <h4 class="text-lg font-bold mb-4 text-center text-green-600">üìñ Soluci√≥n Paso a Paso</h4>
                            <div id="solution-steps" class="space-y-4">
                                <!-- Steps will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Converter Tab -->
                <div id="converter-tab" class="visual-tab hidden">
                    <div class="bg-gradient-to-r from-green-50 to-teal-50 dark:from-green-900/20 dark:to-teal-900/20 rounded-2xl p-8">
                        <h3 class="text-2xl font-bold mb-6 text-center text-green-600">üîÑ Convertidor Universal de Fracciones</h3>
                        
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Input Section -->
                            <div class="space-y-6">
                                <!-- Fraction Input -->
                                <div class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                    <h4 class="text-lg font-bold mb-4 text-center">üìù Ingresa una Fracci√≥n</h4>
                                    <div class="flex justify-center items-center gap-2 mb-4">
                                        <input type="number" id="conv-num" class="w-20 px-3 py-2 text-center text-lg border-2 border-green-300 rounded-lg focus:border-green-500" value="3" min="0">
                                        <span class="text-2xl font-bold">/</span>
                                        <input type="number" id="conv-den" class="w-20 px-3 py-2 text-center text-lg border-2 border-green-300 rounded-lg focus:border-green-500" value="4" min="1">
                                    </div>
                                    <button onclick="convertFraction()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 rounded-xl hover:from-green-600 hover:to-teal-700 transition-all transform hover:scale-105">
                                        üîÑ Convertir
                                    </button>
                                </div>
                                
                                <!-- Decimal Input -->
                                <div class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                    <h4 class="text-lg font-bold mb-4 text-center">üî¢ O ingresa un Decimal</h4>
                                    <input type="number" id="decimal-input" class="w-full px-3 py-2 text-center text-lg border-2 border-blue-300 rounded-lg focus:border-blue-500" step="0.01" placeholder="0.75">
                                    <button onclick="convertDecimal()" class="w-full mt-3 bg-gradient-to-r from-blue-500 to-cyan-600 text-white py-3 rounded-xl hover:from-blue-600 hover:to-cyan-700 transition-all transform hover:scale-105">
                                        üîÑ Convertir Decimal
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Results Section -->
                            <div class="space-y-6">
                                <!-- Conversion Results -->
                                <div id="conversion-results" class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                    <h4 class="text-lg font-bold mb-4 text-center text-purple-600">‚ú® Resultados</h4>
                                    <div class="space-y-4 text-center">
                                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                            <h5 class="font-bold text-blue-600">üìä Fracci√≥n</h5>
                                            <div id="result-fraction" class="text-2xl font-bold">-</div>
                                        </div>
                                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                            <h5 class="font-bold text-green-600">üî¢ Decimal</h5>
                                            <div id="result-decimal" class="text-2xl font-bold">-</div>
                                        </div>
                                        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                            <h5 class="font-bold text-yellow-600">üìà Porcentaje</h5>
                                            <div id="result-percentage" class="text-2xl font-bold">-</div>
                                        </div>
                                        <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                            <h5 class="font-bold text-purple-600">üîÑ N√∫mero Mixto</h5>
                                            <div id="result-mixed" class="text-2xl font-bold">-</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Simplification Steps -->
                                <div id="simplification-steps" class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg hidden">
                                    <h4 class="text-lg font-bold mb-4 text-center text-orange-600">üîß Pasos de Simplificaci√≥n</h4>
                                    <div id="simplify-content" class="space-y-2">
                                        <!-- Simplification steps will be shown here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generator Tab -->
                <div id="generator-tab" class="visual-tab hidden">
                    <div class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-2xl p-8">
                        <h3 class="text-2xl font-bold mb-6 text-center text-orange-600">üéõÔ∏è Generador Personalizado de Problemas</h3>
                        
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Configuration Panel -->
                            <div class="space-y-6">
                                <div class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                    <h4 class="text-lg font-bold mb-4 text-center">‚öôÔ∏è Configuraci√≥n</h4>
                                    
                                    <!-- Difficulty Level -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold mb-2">üìä Nivel de Dificultad:</label>
                                        <select id="difficulty-level" class="w-full p-2 border rounded-lg">
                                            <option value="easy">üü¢ F√°cil (denominadores hasta 8)</option>
                                            <option value="medium">üü° Medio (denominadores hasta 12)</option>
                                            <option value="hard">üî¥ Dif√≠cil (denominadores hasta 20)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Operation Types -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold mb-2">üßÆ Tipos de Operaci√≥n:</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="gen-add" checked class="mr-2">
                                                <span>‚ûï Suma</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="gen-subtract" checked class="mr-2">
                                                <span>‚ûñ Resta</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="gen-multiply" class="mr-2">
                                                <span>‚úñÔ∏è Multiplicaci√≥n</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="gen-divide" class="mr-2">
                                                <span>‚ûó Divisi√≥n</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Problem Context -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold mb-2">üéØ Contexto del Problema:</label>
                                        <select id="problem-context" class="w-full p-2 border rounded-lg">
                                            <option value="abstract">üî¢ Abstracto (solo n√∫meros)</option>
                                            <option value="food">üçï Comida (pizza, pasteles, etc.)</option>
                                            <option value="time">‚è∞ Tiempo (horas, minutos)</option>
                                            <option value="money">üí∞ Dinero (pesos, centavos)</option>
                                            <option value="distance">üìè Distancia (metros, kil√≥metros)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Number of Problems -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold mb-2">üìù Cantidad de Problemas:</label>
                                        <input type="range" id="num-problems" min="1" max="10" value="5" class="w-full">
                                        <div class="text-center mt-1">
                                            <span id="num-problems-display" class="font-bold">5</span> problemas
                                        </div>
                                    </div>
                                    
                                    <button onclick="generateCustomProblems()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 rounded-xl hover:from-orange-600 hover:to-red-700 transition-all transform hover:scale-105">
                                        üé≤ Generar Problemas
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Generated Problems -->
                            <div class="space-y-6">
                                <div id="generated-problems" class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg">
                                    <h4 class="text-lg font-bold mb-4 text-center text-red-600">üìö Problemas Generados</h4>
                                    <div id="problems-list" class="space-y-4">
                                        <div class="text-center text-gray-500 py-8">
                                            Configura los par√°metros y presiona "Generar Problemas"
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Export Options -->
                                <div id="export-options" class="bg-white dark:bg-gray-700 p-6 rounded-xl shadow-lg hidden">
                                    <h4 class="text-lg font-bold mb-4 text-center text-purple-600">üì§ Opciones de Exportaci√≥n</h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="copyToClipboard()" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                                            üìã Copiar
                                        </button>
                                        <button onclick="downloadProblems()" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                            üì• Descargar
                                        </button>
                                        <button onclick="printProblems()" class="bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                                            üñ®Ô∏è Imprimir
                                        </button>
                                        <button onclick="shareProblems()" class="bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                                            üì§ Compartir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Game State
        let gameState = {
            level: 1,
            xp: 0,
            totalPoints: 0,
            streak: 0,
            achievements: [],
            currentLesson: null,
            spaceMissions: 0,
            crystals: 0,
            currentGalaxy: 'Alpha',
            shipLevel: 1,
            energy: 100,
            currentMission: null,
            missionProgress: 0,
            missionScore: 0,
            missionTime: 60,
            missionTimer: null
        };

        // Space Mission Data
        const spaceMissions = {
            basic: {
                name: 'Planeta B√°sico',
                icon: 'ü™ê',
                difficulty: 'F√°cil',
                crystals: 50,
                problems: 5,
                timeLimit: 120,
                operations: ['add', 'subtract'],
                maxDenominator: 8
            },
            advanced: {
                name: 'Estrella Dorada',
                icon: 'üåü',
                difficulty: 'Media',
                crystals: 100,
                problems: 7,
                timeLimit: 180,
                operations: ['add', 'subtract', 'multiply'],
                maxDenominator: 12
            },
            master: {
                name: 'Agujero Negro',
                icon: 'üåå',
                difficulty: 'Experto',
                crystals: 200,
                problems: 10,
                timeLimit: 240,
                operations: ['add', 'subtract', 'multiply', 'divide'],
                maxDenominator: 20
            }
        };

        // Tutorial Content - Expandido y Detallado
        const lessonContents = {
            basics: {
                title: "Conceptos B√°sicos de Fracciones",
                xp: 50,
                content: `
                    <h3 class="text-3xl font-bold mb-8 text-blue-600 text-center">üìö ¬°Bienvenido al Mundo de las Fracciones!</h3>
                    
                    <div class="space-y-8">
                        <!-- Introducci√≥n -->
                        <div class="bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-blue-700 dark:text-blue-300 flex items-center">
                                <span class="text-3xl mr-3">üß†</span> ¬øQu√© es una fracci√≥n?
                            </h4>
                            <p class="text-lg mb-6 leading-relaxed">
                                Una <strong>fracci√≥n</strong> es como un trozo de pizza o un pedazo de chocolate. 
                                Representa <em>una parte de algo completo</em> que ha sido dividido en partes iguales.
                            </p>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl mb-6">
                                <div class="text-center mb-6">
                                    <div class="fraction text-6xl mb-4">
                                        <span class="numerator text-red-600 font-bold">3</span>
                                        <span class="denominator text-blue-600 font-bold">4</span>
                                    </div>
                                    <p class="text-xl font-semibold text-gray-700 dark:text-gray-300">Se lee: "tres cuartos"</p>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="text-center p-6 bg-red-50 dark:bg-red-900/20 rounded-xl border-2 border-red-200 dark:border-red-800">
                                        <div class="text-4xl font-bold text-red-600 mb-3">3</div>
                                        <h5 class="text-lg font-bold text-red-700 dark:text-red-300 mb-2">NUMERADOR</h5>
                                        <p class="text-sm">Indica <strong>cu√°ntas partes</strong> hemos tomado o consideramos</p>
                                        <p class="text-xs mt-2 text-red-600">¬°Va arriba de la l√≠nea!</p>
                                    </div>
                                    <div class="text-center p-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl border-2 border-blue-200 dark:border-blue-800">
                                        <div class="text-4xl font-bold text-blue-600 mb-3">4</div>
                                        <h5 class="text-lg font-bold text-blue-700 dark:text-blue-300 mb-2">DENOMINADOR</h5>
                                        <p class="text-sm">Indica <strong>en cu√°ntas partes iguales</strong> se dividi√≥ el todo</p>
                                        <p class="text-xs mt-2 text-blue-600">¬°Va abajo de la l√≠nea!</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
                                <p class="text-center text-lg"><strong>üí° Recuerda:</strong> El denominador nunca puede ser cero (¬°no puedes dividir en 0 partes!)</p>
                            </div>
                        </div>
                        
                        <!-- Visualizaci√≥n Pr√°ctica -->
                        <div class="bg-gradient-to-r from-green-100 to-teal-100 dark:from-green-900/30 dark:to-teal-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-green-700 dark:text-green-300 flex items-center">
                                <span class="text-3xl mr-3">üéØ</span> Visualizando 3/4
                            </h4>
                            
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <h5 class="text-lg font-bold">üç´ Ejemplo con Chocolate:</h5>
                                    <div class="flex justify-center mb-4">
                                        <div class="grid grid-cols-4 gap-1">
                                            <div class="w-12 h-12 bg-amber-600 rounded border-2 border-amber-800 flex items-center justify-center text-white font-bold">‚úì</div>
                                            <div class="w-12 h-12 bg-amber-600 rounded border-2 border-amber-800 flex items-center justify-center text-white font-bold">‚úì</div>
                                            <div class="w-12 h-12 bg-amber-600 rounded border-2 border-amber-800 flex items-center justify-center text-white font-bold">‚úì</div>
                                            <div class="w-12 h-12 bg-gray-300 rounded border-2 border-gray-500 flex items-center justify-center text-gray-600">‚úó</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-center">
                                        <strong>3 de 4 cuadros</strong> est√°n coloreados<br>
                                        Esto representa <strong>3/4</strong> del chocolate
                                    </p>
                                </div>
                                
                                <div class="space-y-4">
                                    <h5 class="text-lg font-bold">üìä Como porcentaje:</h5>
                                    <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-xl">
                                        <div class="text-center mb-3">
                                            <span class="text-3xl font-bold text-green-600">75%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-6">
                                            <div class="bg-green-500 h-6 rounded-full" style="width: 75%"></div>
                                        </div>
                                        <p class="text-sm text-center mt-2">3/4 = 0.75 = 75%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen Final -->
                        <div class="bg-gradient-to-r from-indigo-100 to-cyan-100 dark:from-indigo-900/30 dark:to-cyan-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-indigo-700 dark:text-indigo-300 flex items-center">
                                <span class="text-3xl mr-3">üìù</span> Resumen de lo que Aprendiste
                            </h4>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <h5 class="text-lg font-bold">‚úÖ Conceptos Clave:</h5>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex items-start"><span class="text-green-500 mr-2">‚ñ∂</span>Fracci√≥n = Parte de un todo</li>
                                        <li class="flex items-start"><span class="text-green-500 mr-2">‚ñ∂</span>Numerador (arriba) = Partes tomadas</li>
                                        <li class="flex items-start"><span class="text-green-500 mr-2">‚ñ∂</span>Denominador (abajo) = Total de partes</li>
                                        <li class="flex items-start"><span class="text-green-500 mr-2">‚ñ∂</span>Denominador nunca puede ser 0</li>
                                    </ul>
                                </div>
                                
                                <div class="space-y-4">
                                    <h5 class="text-lg font-bold">üéØ Tipos que Conoces:</h5>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex items-start"><span class="text-blue-500 mr-2">‚ñ∂</span><strong>Propia:</strong> Numerador < Denominador (menor que 1)</li>
                                        <li class="flex items-start"><span class="text-orange-500 mr-2">‚ñ∂</span><strong>Impropia:</strong> Numerador ‚â• Denominador (mayor que 1)</li>
                                        <li class="flex items-start"><span class="text-purple-500 mr-2">‚ñ∂</span><strong>Mixta:</strong> Entero + Fracci√≥n propia</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mt-6 p-4 bg-white/70 dark:bg-gray-800/70 rounded-xl text-center">
                                <p class="text-lg font-bold text-indigo-600">üéâ ¬°Felicidades!</p>
                                <p class="text-sm">Ya tienes las bases para entender las fracciones. ¬°Ahora puedes avanzar a las operaciones!</p>
                            </div>
                        </div>
                    </div>
                `
            },
            addition: {
                title: "Suma y Resta de Fracciones",
                xp: 75,
                content: `
                    <h3 class="text-3xl font-bold mb-8 text-yellow-600 text-center">‚ûï‚ûñ Dominando Suma y Resta de Fracciones</h3>
                    
                    <div class="space-y-8">
                        <!-- Caso 1: Denominadores Iguales -->
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-green-700 dark:text-green-300 flex items-center">
                                <span class="text-3xl mr-3">üü∞</span> CASO 1: Denominadores Iguales (¬°S√∫per F√°cil!)
                            </h4>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl mb-6">
                                <div class="text-center mb-6">
                                    <div class="text-lg font-bold mb-4 text-green-600">üìù Ejemplo: 2/5 + 1/5</div>
                                    
                                    <!-- Visualizaci√≥n con barras -->
                                    <div class="flex justify-center items-center gap-8 mb-6">
                                        <div class="text-center">
                                            <div class="text-sm mb-2 font-bold">2/5</div>
                                            <div class="flex gap-1">
                                                <div class="w-8 h-12 bg-blue-500 rounded border-2 border-blue-700"></div>
                                                <div class="w-8 h-12 bg-blue-500 rounded border-2 border-blue-700"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-green-600">+</div>
                                        <div class="text-center">
                                            <div class="text-sm mb-2 font-bold">1/5</div>
                                            <div class="flex gap-1">
                                                <div class="w-8 h-12 bg-red-500 rounded border-2 border-red-700"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-green-600">=</div>
                                        <div class="text-center">
                                            <div class="text-sm mb-2 font-bold text-green-600">3/5</div>
                                            <div class="flex gap-1">
                                                <div class="w-8 h-12 bg-green-500 rounded border-2 border-green-700"></div>
                                                <div class="w-8 h-12 bg-green-500 rounded border-2 border-green-700"></div>
                                                <div class="w-8 h-12 bg-green-500 rounded border-2 border-green-700"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                                <div class="w-8 h-12 bg-gray-300 rounded border-2 border-gray-500"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
                                    <h5 class="font-bold text-green-700 mb-3">üîç Pasos a seguir:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center"><span class="text-green-500 mr-2">1Ô∏è‚É£</span>Verificar que los denominadores sean iguales ‚úÖ</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">2Ô∏è‚É£</span>Sumar solo los numeradores: 2 + 1 = 3</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">3Ô∏è‚É£</span>Mantener el mismo denominador: 5</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">‚úÖ</span>Resultado: 3/5</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Caso 2: Denominadores Diferentes -->
                        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-yellow-700 dark:text-yellow-300 flex items-center">
                                <span class="text-3xl mr-3">ü¶ã</span> CASO 2: Denominadores Diferentes (M√©todo Mariposa)
                            </h4>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl mb-6">
                                <div class="text-center mb-6">
                                    <div class="text-lg font-bold mb-4 text-orange-600">üìù Ejemplo: 1/3 + 1/4</div>
                                    
                                    <!-- Visualizaci√≥n del m√©todo mariposa -->
                                    <div class="bg-orange-50 dark:bg-orange-900/20 p-6 rounded-xl mb-6">
                                        <h5 class="text-xl font-bold mb-4 text-center text-orange-600">ü¶ã ¬°M√©todo Mariposa en Acci√≥n!</h5>
                                        
                                        <div class="flex justify-center mb-6">
                                            <div class="grid grid-cols-3 gap-8 items-center">
                                                <!-- Primera fracci√≥n -->
                                                <div class="text-center">
                                                    <div class="relative">
                                                        <div class="fraction text-4xl">
                                                            <span class="numerator text-red-600 font-bold">1</span>
                                                            <span class="denominator text-blue-600 font-bold">3</span>
                                                        </div>
                                                        <!-- Flechas del m√©todo mariposa -->
                                                        <div class="absolute -right-8 top-0 text-red-500 font-bold text-sm">1√ó4</div>
                                                        <div class="absolute -right-8 bottom-0 text-blue-500 font-bold text-sm">3√ó4</div>
                                                    </div>
                                                </div>
                                                
                                                <!-- S√≠mbolo + -->
                                                <div class="text-4xl font-bold text-orange-600">+</div>
                                                
                                                <!-- Segunda fracci√≥n -->
                                                <div class="text-center">
                                                    <div class="relative">
                                                        <div class="fraction text-4xl">
                                                            <span class="numerator text-red-600 font-bold">1</span>
                                                            <span class="denominator text-blue-600 font-bold">4</span>
                                                        </div>
                                                        <!-- Flechas del m√©todo mariposa -->
                                                        <div class="absolute -left-8 top-0 text-red-500 font-bold text-sm">1√ó3</div>
                                                        <div class="absolute -left-8 bottom-0 text-blue-500 font-bold text-sm">4√ó3</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Resultado del m√©todo mariposa -->
                                        <div class="text-center mb-4">
                                            <div class="text-2xl font-bold mb-2">=</div>
                                            <div class="fraction text-4xl">
                                                <span class="numerator text-green-600 font-bold">(1√ó4) + (1√ó3) = 4 + 3 = 7</span>
                                                <span class="denominator text-purple-600 font-bold">3 √ó 4 = 12</span>
                                            </div>
                                            <div class="text-2xl font-bold mt-4 text-green-600">= 7/12</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Verificaci√≥n visual -->
                                    <div class="grid md:grid-cols-3 gap-6 mt-6">
                                        <div class="text-center">
                                            <div class="text-sm font-bold mb-2">1/3</div>
                                            <div class="grid grid-cols-3 gap-1 mb-2">
                                                <div class="w-8 h-8 bg-blue-500 rounded"></div>
                                                <div class="w-8 h-8 bg-gray-300 rounded"></div>
                                                <div class="w-8 h-8 bg-gray-300 rounded"></div>
                                            </div>
                                            <div class="text-xs">= 4/12</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-sm font-bold mb-2">1/4</div>
                                            <div class="grid grid-cols-4 gap-1 mb-2">
                                                <div class="w-6 h-8 bg-red-500 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                            </div>
                                            <div class="text-xs">= 3/12</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-sm font-bold mb-2 text-green-600">7/12</div>
                                            <div class="grid grid-cols-4 gap-1 mb-2">
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                            </div>
                                            <div class="grid grid-cols-4 gap-1 mb-2">
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                                <div class="w-6 h-8 bg-green-500 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                            </div>
                                            <div class="grid grid-cols-4 gap-1">
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                                <div class="w-6 h-8 bg-gray-300 rounded"></div>
                                            </div>
                                            <div class="text-xs">Resultado final</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
                                    <h5 class="font-bold text-yellow-700 mb-3">ü¶ã Pasos del M√©todo Mariposa:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center"><span class="text-yellow-500 mr-2">1Ô∏è‚É£</span>Multiplica el numerador de la primera fracci√≥n por el denominador de la segunda: 1 √ó 4 = 4</div>
                                        <div class="flex items-center"><span class="text-yellow-500 mr-2">2Ô∏è‚É£</span>Multiplica el numerador de la segunda fracci√≥n por el denominador de la primera: 1 √ó 3 = 3</div>
                                        <div class="flex items-center"><span class="text-yellow-500 mr-2">3Ô∏è‚É£</span>Suma los resultados para el numerador: 4 + 3 = 7</div>
                                        <div class="flex items-center"><span class="text-yellow-500 mr-2">4Ô∏è‚É£</span>Multiplica los denominadores: 3 √ó 4 = 12</div>
                                        <div class="flex items-center"><span class="text-yellow-500 mr-2">‚úÖ</span>Resultado: 7/12</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resta con m√©todo mariposa -->
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-purple-700 dark:text-purple-300 flex items-center">
                                <span class="text-3xl mr-3">‚ûñ</span> Resta con M√©todo Mariposa
                            </h4>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl">
                                <div class="text-center mb-6">
                                    <div class="text-lg font-bold mb-4 text-purple-600">üìù Ejemplo: 3/4 - 1/6</div>
                                    
                                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl mb-4">
                                        <div class="text-center text-2xl mb-4">
                                            <span class="fraction">
                                                <span class="numerator text-red-600">3</span>
                                                <span class="denominator text-blue-600">4</span>
                                            </span>
                                            <span class="mx-3">-</span>
                                            <span class="fraction">
                                                <span class="numerator text-red-600">1</span>
                                                <span class="denominator text-blue-600">6</span>
                                            </span>
                                            <span class="mx-3">=</span>
                                            <span class="fraction">
                                                <span class="numerator text-green-600">(3√ó6) - (1√ó4) = 18 - 4 = 14</span>
                                                <span class="denominator text-purple-600">4 √ó 6 = 24</span>
                                            </span>
                                            <span class="mx-3">=</span>
                                            <span class="fraction">
                                                <span class="numerator text-green-600">14</span>
                                                <span class="denominator text-purple-600">24</span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-pink-50 dark:bg-pink-900/20 p-4 rounded-xl">
                                        <h6 class="font-bold mb-2">üîß Simplificaci√≥n:</h6>
                                        <p class="text-sm">14/24 se puede simplificar dividiendo entre 2:</p>
                                        <p class="text-lg font-bold text-center mt-2">14 √∑ 2 = 7, 24 √∑ 2 = 12</p>
                                        <p class="text-xl font-bold text-center text-green-600 mt-2">Resultado final: 7/12</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Consejos importantes -->
                        <div class="bg-gradient-to-r from-indigo-100 to-cyan-100 dark:from-indigo-900/30 dark:to-cyan-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-indigo-700 dark:text-indigo-300 flex items-center">
                                <span class="text-3xl mr-3">üí°</span> Consejos y Trucos
                            </h4>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-xl">
                                    <h5 class="font-bold text-indigo-600 mb-3">üéØ ¬øCu√°ndo usar cada m√©todo?</h5>
                                    <ul class="space-y-2 text-sm">
                                        <li><strong>Denominadores iguales:</strong> Solo suma/resta numeradores</li>
                                        <li><strong>Denominadores diferentes:</strong> Usa m√©todo mariposa</li>
                                        <li><strong>N√∫meros grandes:</strong> Busca denominador com√∫n m√°s peque√±o</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-xl">
                                    <h5 class="font-bold text-cyan-600 mb-3">‚ö†Ô∏è Errores comunes</h5>
                                    <ul class="space-y-2 text-sm">
                                        <li>‚ùå Sumar denominadores cuando son diferentes</li>
                                        <li>‚ùå Olvidar simplificar el resultado</li>
                                        <li>‚úÖ Siempre verificar si se puede simplificar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            multiply: {
                title: "Multiplicaci√≥n y Divisi√≥n de Fracciones",
                xp: 100,
                content: `
                    <h3 class="text-3xl font-bold mb-8 text-purple-600 text-center">‚úñÔ∏è‚ûó Maestro de Multiplicaci√≥n y Divisi√≥n</h3>
                    
                    <div class="space-y-8">
                        <!-- Introducci√≥n -->
                        <div class="bg-gradient-to-r from-purple-100 to-indigo-100 dark:from-purple-900/30 dark:to-indigo-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-purple-700 dark:text-purple-300 flex items-center">
                                <span class="text-3xl mr-3">üöÄ</span> ¬°Las Operaciones M√°s F√°ciles!
                            </h4>
                            <p class="text-lg mb-6 leading-relaxed">
                                Multiplicar y dividir fracciones es <strong>m√°s f√°cil</strong> que sumarlas y restarlas. 
                                ¬°Solo aplicas reglas directas sin necesidad del m√©todo mariposa!
                            </p>
                            
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl">
                                <p class="text-center text-lg"><strong>üéØ Regla de oro:</strong> Multiplicas directo, para dividir inviertes y multiplicas</p>
                            </div>
                        </div>
                        
                        <!-- Multiplicaci√≥n -->
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-green-700 dark:text-green-300 flex items-center">
                                <span class="text-3xl mr-3">‚úñÔ∏è</span> Multiplicaci√≥n: ¬°S√∫per Directa!
                            </h4>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl mb-6">
                                <div class="text-center mb-6">
                                    <div class="text-lg font-bold mb-4 text-green-600">üìù Ejemplo: 2/3 √ó 3/4</div>
                                    
                                    <!-- F√≥rmula visual -->
                                    <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl mb-6">
                                        <h5 class="text-xl font-bold mb-4 text-center text-green-600">‚úñÔ∏è ¬°Multiplica en L√≠nea Recta!</h5>
                                        
                                        <div class="flex justify-center items-center gap-4 mb-6">
                                            <div class="text-center">
                                                <div class="fraction text-4xl">
                                                    <span class="numerator text-red-600 font-bold">2</span>
                                                    <span class="denominator text-blue-600 font-bold">3</span>
                                                </div>
                                            </div>
                                            <div class="text-4xl font-bold text-green-600">√ó</div>
                                            <div class="text-center">
                                                <div class="fraction text-4xl">
                                                    <span class="numerator text-red-600 font-bold">3</span>
                                                    <span class="denominator text-blue-600 font-bold">4</span>
                                                </div>
                                            </div>
                                            <div class="text-4xl font-bold text-green-600">=</div>
                                            <div class="text-center">
                                                <div class="fraction text-4xl">
                                                    <span class="numerator text-green-600 font-bold">2√ó3 = 6</span>
                                                    <span class="denominator text-purple-600 font-bold">3√ó4 = 12</span>
                                                </div>
                                                <div class="text-2xl font-bold mt-4 text-green-600">= 6/12 = 1/2</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Visualizaci√≥n con rect√°ngulos -->
                                        <div class="grid md:grid-cols-3 gap-6">
                                            <div class="text-center">
                                                <div class="text-sm font-bold mb-2">2/3 de una barra</div>
                                                <div class="w-24 h-16 bg-gray-300 rounded mx-auto relative">
                                                    <div class="w-16 h-16 bg-blue-500 rounded-l absolute left-0"></div>
                                                </div>
                                                <div class="text-xs mt-1">2 de 3 partes</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-sm font-bold mb-2">3/4 de ese resultado</div>
                                                <div class="w-16 h-16 bg-blue-500 rounded mx-auto relative">
                                                    <div class="w-12 h-16 bg-green-500 rounded-l absolute left-0"></div>
                                                </div>
                                                <div class="text-xs mt-1">3 de 4 partes del azul</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-sm font-bold mb-2 text-green-600">Resultado: 1/2</div>
                                                <div class="w-24 h-16 bg-gray-300 rounded mx-auto relative">
                                                    <div class="w-12 h-16 bg-green-500 rounded-l absolute left-0"></div>
                                                </div>
                                                <div class="text-xs mt-1">La mitad del total</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
                                    <h5 class="font-bold text-green-700 mb-3">‚úñÔ∏è Pasos para Multiplicar:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center"><span class="text-green-500 mr-2">1Ô∏è‚É£</span>Multiplica numerador por numerador: 2 √ó 3 = 6</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">2Ô∏è‚É£</span>Multiplica denominador por denominador: 3 √ó 4 = 12</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">3Ô∏è‚É£</span>Resultado: 6/12</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">4Ô∏è‚É£</span>Simplifica: 6/12 = 1/2 (dividiendo entre 6)</div>
                                        <div class="flex items-center"><span class="text-green-500 mr-2">‚úÖ</span>Respuesta final: 1/2</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Divisi√≥n -->
                        <div class="bg-gradient-to-r from-cyan-100 to-blue-100 dark:from-cyan-900/30 dark:to-blue-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-cyan-700 dark:text-cyan-300 flex items-center">
                                <span class="text-3xl mr-3">‚ûó</span> Divisi√≥n: Invertir y Multiplicar
                            </h4>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl mb-6">
                                <div class="text-center mb-6">
                                    <div class="text-lg font-bold mb-4 text-cyan-600">üìù Ejemplo: 3/4 √∑ 2/5</div>
                                    
                                    <!-- Proceso de inversi√≥n -->
                                    <div class="bg-cyan-50 dark:bg-cyan-900/20 p-6 rounded-xl mb-6">
                                        <h5 class="text-xl font-bold mb-4 text-center text-cyan-600">üîÑ ¬°Invierte y Multiplica!</h5>
                                        
                                        <div class="space-y-6">
                                            <!-- Paso 1: Divisi√≥n original -->
                                            <div class="flex justify-center items-center gap-4">
                                                <div class="text-center">
                                                    <div class="fraction text-3xl">
                                                        <span class="numerator text-red-600 font-bold">3</span>
                                                        <span class="denominator text-blue-600 font-bold">4</span>
                                                    </div>
                                                </div>
                                                <div class="text-3xl font-bold text-cyan-600">√∑</div>
                                                <div class="text-center">
                                                    <div class="fraction text-3xl">
                                                        <span class="numerator text-red-600 font-bold">2</span>
                                                        <span class="denominator text-blue-600 font-bold">5</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Flecha de transformaci√≥n -->
                                            <div class="text-center">
                                                <div class="text-2xl">‚¨áÔ∏è</div>
                                                <div class="text-lg font-bold text-cyan-600">¬°Invierte la segunda fracci√≥n!</div>
                                            </div>
                                            
                                            <!-- Paso 2: Conversi√≥n a multiplicaci√≥n -->
                                            <div class="flex justify-center items-center gap-4">
                                                <div class="text-center">
                                                    <div class="fraction text-3xl">
                                                        <span class="numerator text-red-600 font-bold">3</span>
                                                        <span class="denominator text-blue-600 font-bold">4</span>
                                                    </div>
                                                </div>
                                                <div class="text-3xl font-bold text-green-600">√ó</div>
                                                <div class="text-center relative">
                                                    <div class="fraction text-3xl">
                                                        <span class="numerator text-blue-600 font-bold">5</span>
                                                        <span class="denominator text-red-600 font-bold">2</span>
                                                    </div>
                                                    <div class="absolute -top-2 -right-2 bg-yellow-400 text-black text-xs px-1 rounded">¬°Invertida!</div>
                                                </div>
                                                <div class="text-3xl font-bold text-green-600">=</div>
                                                <div class="text-center">
                                                    <div class="fraction text-3xl">
                                                        <span class="numerator text-green-600 font-bold">3√ó5 = 15</span>
                                                        <span class="denominator text-purple-600 font-bold">4√ó2 = 8</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <div class="text-2xl font-bold text-green-600">Resultado: 15/8 = 1 7/8</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Explicaci√≥n visual con ejemplos cotidianos -->
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl mb-4">
                                        <h6 class="font-bold mb-2 text-blue-700">üß† ¬øPor qu√© funciona?</h6>
                                        <p class="text-sm mb-2">Dividir entre una fracci√≥n es como preguntar: "¬øCu√°ntas veces cabe 2/5 en 3/4?"</p>
                                        <p class="text-sm">Es lo mismo que multiplicar por su inverso 5/2. ¬°Como si fuera magia matem√°tica!</p>
                                    </div>
                                </div>
                                
                                <div class="bg-cyan-50 dark:bg-cyan-900/20 p-4 rounded-xl">
                                    <h5 class="font-bold text-cyan-700 mb-3">‚ûó Pasos para Dividir:</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center"><span class="text-cyan-500 mr-2">1Ô∏è‚É£</span>Mant√©n la primera fracci√≥n igual: 3/4</div>
                                        <div class="flex items-center"><span class="text-cyan-500 mr-2">2Ô∏è‚É£</span>Invierte la segunda fracci√≥n: 2/5 ‚Üí 5/2</div>
                                        <div class="flex items-center"><span class="text-cyan-500 mr-2">3Ô∏è‚É£</span>Cambia √∑ por √ó: 3/4 √ó 5/2</div>
                                        <div class="flex items-center"><span class="text-cyan-500 mr-2">4Ô∏è‚É£</span>Multiplica: (3√ó5)/(4√ó2) = 15/8</div>
                                        <div class="flex items-center"><span class="text-cyan-500 mr-2">‚úÖ</span>Convierte a mixto: 15/8 = 1 7/8</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Truco de simplificaci√≥n -->
                        <div class="bg-gradient-to-r from-orange-100 to-yellow-100 dark:from-orange-900/30 dark:to-yellow-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-orange-700 dark:text-orange-300 flex items-center">
                                <span class="text-3xl mr-3">‚ö°</span> Truco PRO: Simplificar Antes de Multiplicar
                            </h4>
                            
                            <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl">
                                <div class="text-center mb-6">
                                    <div class="text-lg font-bold mb-4 text-orange-600">üìù Ejemplo: 6/8 √ó 4/9</div>
                                    
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl">
                                            <h6 class="font-bold text-red-600 mb-3">‚ùå M√©todo Normal (m√°s dif√≠cil)</h6>
                                            <div class="space-y-2 text-sm">
                                                <div>6/8 √ó 4/9 = (6√ó4)/(8√ó9) = 24/72</div>
                                                <div>Ahora simplificar 24/72 = 1/3</div>
                                                <div class="text-red-600">¬°N√∫meros m√°s grandes!</div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl">
                                            <h6 class="font-bold text-green-600 mb-3">‚úÖ M√©todo PRO (m√°s f√°cil)</h6>
                                            <div class="space-y-2 text-sm">
                                                <div>6/8 √ó 4/9</div>
                                                <div>Cancelamos: 6 y 9 (√∑3), 8 y 4 (√∑4)</div>
                                                <div>2/2 √ó 1/3 = 2/6 = 1/3</div>
                                                <div class="text-green-600">¬°N√∫meros m√°s peque√±os!</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl">
                                        <p class="text-sm"><strong>üí° Tip:</strong> Busca n√∫meros que puedas cancelar en diagonales o cruces antes de multiplicar</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen final -->
                        <div class="bg-gradient-to-r from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 p-8 rounded-2xl">
                            <h4 class="text-2xl font-bold mb-6 text-indigo-700 dark:text-indigo-300 flex items-center">
                                <span class="text-3xl mr-3">üéØ</span> Resumen: ¬°Ahora eres un Experto!
                            </h4>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl">
                                    <h5 class="font-bold text-green-600 mb-4 text-center">‚úñÔ∏è Multiplicaci√≥n</h5>
                                    <div class="text-center mb-4">
                                        <div class="text-2xl">
                                            <span class="fraction">
                                                <span class="numerator text-red-600">a</span>
                                                <span class="denominator text-blue-600">b</span>
                                            </span>
                                            <span class="mx-2">√ó</span>
                                            <span class="fraction">
                                                <span class="numerator text-red-600">c</span>
                                                <span class="denominator text-blue-600">d</span>
                                            </span>
                                            <span class="mx-2">=</span>
                                            <span class="fraction">
                                                <span class="numerator text-green-600">a√óc</span>
                                                <span class="denominator text-purple-600">b√ód</span>
                                            </span>
                                        </div>
                                    </div>
                                    <ul class="space-y-1 text-sm">
                                        <li>‚úÖ Multiplica numeradores</li>
                                        <li>‚úÖ Multiplica denominadores</li>
                                        <li>‚úÖ Simplifica el resultado</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white/70 dark:bg-gray-800/70 p-6 rounded-xl">
                                    <h5 class="font-bold text-cyan-600 mb-4 text-center">‚ûó Divisi√≥n</h5>
                                    <div class="text-center mb-4">
                                        <div class="text-2xl">
                                            <span class="fraction">
                                                <span class="numerator text-red-600">a</span>
                                                <span class="denominator text-blue-600">b</span>
                                            </span>
                                            <span class="mx-2">√∑</span>
                                            <span class="fraction">
                                                <span class="numerator text-red-600">c</span>
                                                <span class="denominator text-blue-600">d</span>
                                            </span>
                                            <span class="mx-2">=</span>
                                            <span class="fraction">
                                                <span class="numerator text-red-600">a</span>
                                                <span class="denominator text-blue-600">b</span>
                                            </span>
                                            <span class="mx-2">√ó</span>
                                            <span class="fraction">
                                                <span class="numerator text-blue-600">d</span>
                                                <span class="denominator text-red-600">c</span>
                                            </span>
                                        </div>
                                    </div>
                                    <ul class="space-y-1 text-sm">
                                        <li>‚úÖ Invierte la segunda fracci√≥n</li>
                                        <li>‚úÖ Cambia √∑ por √ó</li>
                                        <li>‚úÖ Multiplica normalmente</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mt-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-xl text-center">
                                <p class="text-lg font-bold text-indigo-600">üéâ ¬°Felicidades!</p>
                                <p class="text-sm mt-2">Ahora dominas todas las operaciones b√°sicas con fracciones. ¬°Eres imparable!</p>
                                <p class="text-xs mt-2 text-gray-600">¬°Contin√∫a practicando en las otras secciones de Fracci√≥n Quest!</p>
                            </div>
                        </div>
                    </div>
                `
            }
        };

        // Initialize game
        function initGame() {
            updateUI();
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = 'nav-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg';
            });
            
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Reset practice section if going to practice
            if (sectionId === 'practice') {
                resetPracticeSection();
            }
            
            if (event && event.target) {
                event.target.className = 'nav-btn bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-6 py-3 rounded-2xl hover:from-blue-600 hover:to-cyan-700 transition-all duration-300 transform hover:scale-105 shadow-lg';
            }
        }

        // Tutorial System
        function showLessonDetail(lessonType) {
            const lesson = lessonContents[lessonType];
            if (!lesson) return;
            
            document.getElementById('lesson-selection').classList.add('hidden');
            document.getElementById('lesson-detail').classList.remove('hidden');
            
            document.getElementById('lesson-content-display').innerHTML = lesson.content;
            gameState.currentLesson = lessonType;
            
            const completeBtn = document.getElementById('complete-lesson-btn');
            completeBtn.innerHTML = `Completar Lecci√≥n (+${lesson.xp} XP) ‚ú®`;
        }

        function backToLessons() {
            document.getElementById('lesson-selection').classList.remove('hidden');
            document.getElementById('lesson-detail').classList.add('hidden');
            gameState.currentLesson = null;
        }

        function completeLessonDirect() {
            if (!gameState.currentLesson) return;
            
            const lesson = lessonContents[gameState.currentLesson];
            addXP(lesson.xp);
            addPoints(lesson.xp * 2);
            
            showNotification(`üéì ¬°Lecci√≥n completada! +${lesson.xp} XP`, 'success');
            createConfetti();
            
            backToLessons();
        }

        // Space Adventure System
        function startSpaceMission(missionType) {
            const mission = spaceMissions[missionType];
            if (!mission) return;

            gameState.currentMission = missionType;
            gameState.missionProgress = 0;
            gameState.missionScore = 0;
            gameState.missionTime = mission.timeLimit;

            document.getElementById('mission-selection').classList.add('hidden');
            document.getElementById('mission-interface').classList.remove('hidden');
            
            document.getElementById('mission-title').innerHTML = `${mission.icon} ${mission.name}`;
            
            // Start mission timer
            gameState.missionTimer = setInterval(() => {
                gameState.missionTime--;
                document.getElementById('mission-time').textContent = gameState.missionTime;
                
                if (gameState.missionTime <= 0) {
                    endMission();
                }
            }, 1000);

            generateSpaceProblem();
            updateMissionUI();
        }

        function generateSpaceProblem() {
            const mission = spaceMissions[gameState.currentMission];
            const operations = mission.operations;
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            const maxDen = mission.maxDenominator;
            let num1 = Math.floor(Math.random() * (maxDen - 1)) + 1;
            let den1 = Math.floor(Math.random() * maxDen) + 2;
            let num2 = Math.floor(Math.random() * (maxDen - 1)) + 1;
            let den2 = Math.floor(Math.random() * maxDen) + 2;

            let correctAnswer, symbol;
            
            switch(operation) {
                case 'add':
                    correctAnswer = simplifyFraction((num1 * den2) + (num2 * den1), den1 * den2);
                    symbol = '+';
                    break;
                case 'subtract':
                    if (num1 * den2 >= num2 * den1) {
                        correctAnswer = simplifyFraction((num1 * den2) - (num2 * den1), den1 * den2);
                    } else {
                        correctAnswer = simplifyFraction((num2 * den1) - (num1 * den2), den1 * den2);
                        [num1, den1, num2, den2] = [num2, den2, num1, den1];
                    }
                    symbol = '-';
                    break;
                case 'multiply':
                    correctAnswer = simplifyFraction(num1 * num2, den1 * den2);
                    symbol = '√ó';
                    break;
                case 'divide':
                    correctAnswer = simplifyFraction(num1 * den2, den1 * num2);
                    symbol = '√∑';
                    break;
            }

            gameState.currentProblem = { num1, den1, num2, den2, operation, correctAnswer, symbol };

            document.getElementById('problem-display').innerHTML = `
                <div class="space-y-4">
                    <p class="text-lg">¬°Tu nave necesita calcular la trayectoria!</p>
                    <div class="text-4xl">
                        <span class="fraction">
                            <span class="numerator">${num1}</span>
                            <span class="denominator">${den1}</span>
                        </span>
                        <span class="mx-4">${symbol}</span>
                        <span class="fraction">
                            <span class="numerator">${num2}</span>
                            <span class="denominator">${den2}</span>
                        </span>
                        <span class="mx-4">=</span>
                        <span class="text-yellow-400">?</span>
                    </div>
                </div>
            `;

            generateSpaceOptions(correctAnswer);
        }

        function generateSpaceOptions(correctAnswer) {
            const options = [correctAnswer];
            
            // Generate wrong answers
            while (options.length < 4) {
                const wrongNum = Math.max(1, correctAnswer[0] + Math.floor(Math.random() * 6) - 3);
                const wrongDen = Math.max(1, correctAnswer[1] + Math.floor(Math.random() * 6) - 3);
                
                const wrong = [wrongNum, wrongDen];
                if (!options.some(opt => opt[0] === wrong[0] && opt[1] === wrong[1])) {
                    options.push(wrong);
                }
            }

            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }

            const optionsHtml = options.map((option, index) => `
                <button onclick="checkSpaceAnswer(${option[0]}, ${option[1]})" 
                        class="space-option bg-gradient-to-r from-cyan-400 to-blue-500 text-white p-4 rounded-xl hover:from-cyan-500 hover:to-blue-600 transition-all transform hover:scale-105 shadow-lg text-xl">
                    <span class="fraction">
                        <span class="numerator">${option[0]}</span>
                        <span class="denominator">${option[1]}</span>
                    </span>
                </button>
            `).join('');

            document.getElementById('space-options').innerHTML = optionsHtml;
        }

        function checkSpaceAnswer(selectedNum, selectedDen) {
            if (!gameState.currentProblem) return;

            const correct = gameState.currentProblem.correctAnswer;
            const isCorrect = selectedNum === correct[0] && selectedDen === correct[1];

            // Disable all buttons
            document.querySelectorAll('.space-option').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('pointer-events-none');
                
                const fractionText = btn.querySelector('.fraction');
                const num = parseInt(fractionText.querySelector('.numerator').textContent);
                const den = parseInt(fractionText.querySelector('.denominator').textContent);
                
                if (num === selectedNum && den === selectedDen) {
                    if (isCorrect) {
                        btn.classList.remove('from-cyan-400', 'to-blue-500');
                        btn.classList.add('from-green-500', 'to-emerald-600', 'animate-pop');
                    } else {
                        btn.classList.remove('from-cyan-400', 'to-blue-500');
                        btn.classList.add('from-red-500', 'to-red-600');
                    }
                } else if (num === correct[0] && den === correct[1] && !isCorrect) {
                    btn.classList.remove('from-cyan-400', 'to-blue-500');
                    btn.classList.add('from-green-500', 'to-emerald-600');
                }
            });

            if (isCorrect) {
                gameState.missionProgress++;
                gameState.missionScore += 100;
                createMiniConfetti();
                
                setTimeout(() => {
                    const mission = spaceMissions[gameState.currentMission];
                    if (gameState.missionProgress >= mission.problems) {
                        endMission();
                    } else {
                        generateSpaceProblem();
                    }
                }, 1500);
            } else {
                setTimeout(() => {
                    generateSpaceProblem();
                }, 2000);
            }

            updateMissionUI();
        }

        function updateMissionUI() {
            const mission = spaceMissions[gameState.currentMission];
            document.getElementById('mission-progress').textContent = `${gameState.missionProgress}/${mission.problems}`;
            document.getElementById('mission-score').textContent = gameState.missionScore;
            document.getElementById('mission-time').textContent = gameState.missionTime;
        }

        function endMission() {
            if (gameState.missionTimer) {
                clearInterval(gameState.missionTimer);
                gameState.missionTimer = null;
            }

            const mission = spaceMissions[gameState.currentMission];
            const completionRate = gameState.missionProgress / mission.problems;
            const crystalsEarned = Math.floor(mission.crystals * completionRate);
            const xpEarned = Math.floor(crystalsEarned / 2);

            gameState.spaceMissions++;
            gameState.crystals += crystalsEarned;
            addXP(xpEarned);
            addPoints(crystalsEarned);

            document.getElementById('space-problem').classList.add('hidden');
            document.getElementById('mission-results').classList.remove('hidden');
            
            document.getElementById('mission-summary').innerHTML = `
                <div class="space-y-2">
                    <p><strong>Problemas resueltos:</strong> ${gameState.missionProgress}/${mission.problems}</p>
                    <p><strong>Puntuaci√≥n:</strong> ${gameState.missionScore}</p>
                    <p><strong>Cristales ganados:</strong> +${crystalsEarned} üíé</p>
                    <p><strong>XP ganado:</strong> +${xpEarned} ‚≠ê</p>
                    <div class="text-2xl mt-4">
                        ${completionRate >= 0.8 ? 'üåü ¬°Excelente trabajo!' : 
                          completionRate >= 0.6 ? 'üëç ¬°Buen trabajo!' : 
                          'üí™ ¬°Sigue practicando!'}
                    </div>
                </div>
            `;

            showNotification(`üöÄ Misi√≥n completada: +${crystalsEarned} cristales!`, 'success');
            createConfetti();
        }

        function exitMission() {
            if (gameState.missionTimer) {
                clearInterval(gameState.missionTimer);
                gameState.missionTimer = null;
            }
            returnToMissions();
        }

        function returnToMissions() {
            document.getElementById('mission-selection').classList.remove('hidden');
            document.getElementById('mission-interface').classList.add('hidden');
            document.getElementById('space-problem').classList.remove('hidden');
            document.getElementById('mission-results').classList.add('hidden');
            
            gameState.currentMission = null;
            gameState.missionProgress = 0;
            gameState.missionScore = 0;
        }

        // Challenge System
        let challengeState = {
            currentProblem: 0,
            score: 0,
            correct: 0,
            streak: 0,
            timer: null,
            timeLeft: 120,
            problems: [],
            started: false
        };

        const challengeProblems = [
            {
                display: '(1/2 √ó 3/4) + 1/6',
                solution: [13, 24],
                hint: 'Primero resuelve la multiplicaci√≥n (1/2 √ó 3/4 = 3/8), luego suma 3/8 + 1/6 usando m√©todo mariposa',
                emoji: 'üî¢'
            },
            {
                display: '2/3 - (1/4 √ó 2/5)', 
                solution: [17, 30],
                hint: 'Resuelve primero el par√©ntesis (1/4 √ó 2/5 = 2/20 = 1/10), luego resta 2/3 - 1/10',
                emoji: '‚ö°'
            },
            {
                display: '(3/5 √∑ 2/3) + 1/10',
                solution: [1, 1],
                hint: 'Para dividir, invierte y multiplica: 3/5 √∑ 2/3 = 3/5 √ó 3/2, luego suma el resultado con 1/10',
                emoji: 'üöÄ'
            },
            {
                display: '1/2 + (3/8 √ó 4/9)',
                solution: [2, 3],
                hint: 'Multiplica primero 3/8 √ó 4/9 (puedes simplificar antes), luego suma con 1/2',
                emoji: '‚≠ê'
            },
            {
                display: '(5/6 - 1/4) √ó 2/3',
                solution: [7, 18],
                hint: 'Primero resta usando m√©todo mariposa: 5/6 - 1/4, luego multiplica el resultado por 2/3',
                emoji: 'üéØ'
            }
        ];

        function startChallenge() {
            challengeState = {
                currentProblem: 0,
                score: 0,
                correct: 0,
                streak: 0,
                timer: null,
                timeLeft: 60,
                problems: [...challengeProblems],
                started: true
            };

            document.getElementById('challenge-start').classList.add('hidden');
            document.getElementById('challenge-interface').classList.remove('hidden');

            startChallengeProblem();
        }

        function startChallengeProblem() {
            if (challengeState.currentProblem >= challengeState.problems.length) {
                finishChallenge();
                return;
            }

            const problem = challengeState.problems[challengeState.currentProblem];
            challengeState.timeLeft = 120;

            // Update progress
            const progress = ((challengeState.currentProblem + 1) / challengeState.problems.length) * 100;
            document.getElementById('challenge-progress').textContent = `${challengeState.currentProblem + 1}/5`;
            document.getElementById('challenge-progress-bar').style.width = progress + '%';

            // Update problem display
            document.getElementById('challenge-emoji').textContent = problem.emoji;
            document.getElementById('challenge-question-title').textContent = `Problema ${challengeState.currentProblem + 1}`;
            document.getElementById('challenge-problem').innerHTML = problem.display;

            // Generate options
            generateChallengeOptions(problem.solution);

            // Hide hint
            document.getElementById('challenge-hint').classList.add('hidden');

            // Start timer
            if (challengeState.timer) clearInterval(challengeState.timer);
            challengeState.timer = setInterval(() => {
                challengeState.timeLeft--;
                document.getElementById('challenge-time').textContent = challengeState.timeLeft;
                
                if (challengeState.timeLeft <= 0) {
                    nextChallengeProblem(false);
                }
            }, 1000);

            updateChallengeStats();
        }

        function generateChallengeOptions(correctAnswer) {
            const options = [correctAnswer];
            
            while (options.length < 4) {
                let wrongNum, wrongDen;
                
                if (Math.random() < 0.5) {
                    wrongNum = Math.max(1, correctAnswer[0] + Math.floor(Math.random() * 6) - 3);
                    wrongDen = correctAnswer[1];
                } else {
                    wrongNum = correctAnswer[0];
                    wrongDen = Math.max(1, correctAnswer[1] + Math.floor(Math.random() * 6) - 3);
                }
                
                const wrong = simplifyFraction(wrongNum, wrongDen);
                if (!options.some(opt => opt[0] === wrong[0] && opt[1] === wrong[1])) {
                    options.push(wrong);
                }
            }

            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }

            const optionsHtml = options.map((option, index) => {
                const displayText = option[1] === 1 ? option[0].toString() : 
                    `<span class="fraction"><span class="numerator">${option[0]}</span><span class="denominator">${option[1]}</span></span>`;
                
                return `
                <button onclick="checkChallengeAnswer(${option[0]}, ${option[1]})" 
                        class="challenge-option bg-gradient-to-r from-orange-400 to-red-500 text-white p-4 rounded-xl hover:from-orange-500 hover:to-red-600 transition-all transform hover:scale-105 shadow-lg text-xl">
                    ${displayText}
                </button>
            `;
            }).join('');

            document.getElementById('challenge-options').innerHTML = optionsHtml;
        }

        function checkChallengeAnswer(selectedNum, selectedDen) {
            if (challengeState.timer) {
                clearInterval(challengeState.timer);
                challengeState.timer = null;
            }

            const problem = challengeState.problems[challengeState.currentProblem];
            const correct = problem.solution;
            const isCorrect = selectedNum === correct[0] && selectedDen === correct[1];

            // Disable all buttons and show results
            document.querySelectorAll('.challenge-option').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('pointer-events-none');
                
                const isThisButton = btn.onclick.toString().includes(`${selectedNum}, ${selectedDen}`);
                
                if (isThisButton) {
                    if (isCorrect) {
                        btn.classList.remove('from-orange-400', 'to-red-500');
                        btn.classList.add('from-green-500', 'to-emerald-600', 'animate-pop');
                    } else {
                        btn.classList.remove('from-orange-400', 'to-red-500');
                        btn.classList.add('from-red-600', 'to-red-700');
                    }
                } else if (!isCorrect) {
                    const isCorrectButton = btn.onclick.toString().includes(`${correct[0]}, ${correct[1]}`);
                    if (isCorrectButton) {
                        btn.classList.remove('from-orange-400', 'to-red-500');
                        btn.classList.add('from-green-500', 'to-emerald-600');
                    }
                }
            });

            if (isCorrect) {
                challengeState.correct++;
                challengeState.streak++;
                challengeState.score += 100 + (challengeState.timeLeft * 2);
                createMiniConfetti();
            } else {
                challengeState.streak = 0;
            }

            updateChallengeStats();

            setTimeout(() => {
                nextChallengeProblem(isCorrect);
            }, 2000);
        }

        function nextChallengeProblem(wasCorrect) {
            challengeState.currentProblem++;
            
            if (challengeState.currentProblem >= challengeState.problems.length) {
                finishChallenge();
            } else {
                startChallengeProblem();
            }
        }

        function showHint() {
            const problem = challengeState.problems[challengeState.currentProblem];
            document.getElementById('challenge-hint-text').textContent = problem.hint;
            document.getElementById('challenge-hint').classList.remove('hidden');
            
            document.getElementById('hint-btn').disabled = true;
            document.getElementById('hint-btn').classList.add('opacity-50');
        }

        function finishChallenge() {
            if (challengeState.timer) {
                clearInterval(challengeState.timer);
                challengeState.timer = null;
            }

            const accuracy = (challengeState.correct / challengeState.problems.length) * 100;
            const xpEarned = challengeState.score / 10 + 200;
            
            addXP(xpEarned);
            addPoints(challengeState.score);

            document.getElementById('challenge-interface').classList.add('hidden');
            document.getElementById('challenge-results').classList.remove('hidden');

            document.getElementById('challenge-final-stats').innerHTML = `
                <div class="space-y-3">
                    <p><strong>Respuestas correctas:</strong> ${challengeState.correct}/5</p>
                    <p><strong>Precisi√≥n:</strong> ${accuracy.toFixed(1)}%</p>
                    <p><strong>Puntuaci√≥n final:</strong> ${challengeState.score}</p>
                    <p class="text-green-600 font-bold"><strong>XP ganado:</strong> +${xpEarned}</p>
                    <div class="text-2xl mt-4">
                        ${accuracy >= 80 ? 'üèÜ ¬°Maestro de las fracciones!' : 
                          accuracy >= 60 ? '‚≠ê ¬°Excelente trabajo!' : 
                          accuracy >= 40 ? 'üëç ¬°Buen esfuerzo!' : 'üí™ ¬°Sigue practicando!'}
                    </div>
                </div>
            `;

            createConfetti();
            showNotification(`üéâ Desaf√≠o completado: +${xpEarned} XP!`, 'success');
        }

        function updateChallengeStats() {
            document.getElementById('challenge-score').textContent = challengeState.score;
            document.getElementById('challenge-correct').textContent = challengeState.correct;
            document.getElementById('challenge-streak').textContent = challengeState.streak;
        }

        function exitChallenge() {
            if (challengeState.timer) {
                clearInterval(challengeState.timer);
                challengeState.timer = null;
            }

            document.getElementById('challenge-start').classList.remove('hidden');
            document.getElementById('challenge-interface').classList.add('hidden');
            document.getElementById('challenge-results').classList.add('hidden');

            challengeState.started = false;
        }

        // Practice System
        let practiceState = {
            currentExercise: 0,
            completed: 0,
            correct: 0,
            exercises: [],
            started: false,
            showingResult: false
        };

        const practiceExercises = [
            {
                display: '1/2 + 1/3',
                type: 'Suma con denominadores diferentes',
                solution: [5, 6],
                hint: 'Usa el m√©todo mariposa: (1√ó3) + (1√ó2) = 3+2 = 5, denominador: 2√ó3 = 6',
                explanation: 'Para sumar fracciones con denominadores diferentes, usamos el m√©todo mariposa. Multiplicamos 1√ó3=3 y 1√ó2=2, sumamos: 3+2=5. El denominador es 2√ó3=6. Resultado: 5/6.',
                emoji: '‚ûï'
            },
            {
                display: '3/4 - 1/6',
                type: 'Resta con m√©todo mariposa',
                solution: [7, 12],
                hint: 'M√©todo mariposa: (3√ó6) - (1√ó4) = 18-4 = 14, denominador: 4√ó6 = 24. Luego simplifica 14/24',
                explanation: 'Aplicamos el m√©todo mariposa: (3√ó6) - (1√ó4) = 18-4 = 14, denominador: 4√ó6 = 24. Tenemos 14/24. Simplificamos dividiendo entre 2: 14√∑2=7, 24√∑2=12. Resultado: 7/12.',
                emoji: '‚ûñ'
            },
            {
                display: '2/3 √ó 3/4',
                type: 'Multiplicaci√≥n directa',
                solution: [1, 2],
                hint: 'Multiplica numeradores: 2√ó3=6, denominadores: 3√ó4=12, luego simplifica 6/12',
                explanation: 'Para multiplicar fracciones, multiplicamos numeradores entre s√≠ y denominadores entre s√≠: (2√ó3)/(3√ó4) = 6/12. Simplificamos dividiendo entre 6: 6√∑6=1, 12√∑6=2. Resultado: 1/2.',
                emoji: '‚úñÔ∏è'
            },
            {
                display: '5/8 √∑ 2/3',
                type: 'Divisi√≥n (invertir y multiplicar)',
                solution: [15, 16],
                hint: 'Invierte la segunda fracci√≥n: 2/3 ‚Üí 3/2, luego multiplica: 5/8 √ó 3/2',
                explanation: 'Para dividir fracciones, invertimos la segunda fracci√≥n y multiplicamos: 5/8 √∑ 2/3 = 5/8 √ó 3/2. Multiplicamos: (5√ó3)/(8√ó2) = 15/16. Ya est√° simplificado.',
                emoji: '‚ûó'
            },
            {
                display: '(1/2 + 1/4) √ó 2',
                type: 'Operaciones combinadas con par√©ntesis',
                solution: [3, 2],
                hint: 'Primero resuelve el par√©ntesis: 1/2 + 1/4, luego multiplica el resultado por 2',
                explanation: 'Primero resolvemos el par√©ntesis: 1/2 + 1/4 = 2/4 + 1/4 = 3/4. Luego multiplicamos por 2: 3/4 √ó 2 = 3/4 √ó 2/1 = 6/4 = 3/2.',
                emoji: 'üî¢'
            },
            {
                display: '7/10 - 2/5',
                type: 'Resta con denominador com√∫n',
                solution: [3, 10],
                hint: 'Convierte 2/5 a d√©cimos: 2/5 = 4/10, luego resta: 7/10 - 4/10',
                explanation: 'Convertimos 2/5 a d√©cimos: 2/5 = 4/10 (multiplicando numerador y denominador por 2). Ahora restamos: 7/10 - 4/10 = 3/10.',
                emoji: 'üîß'
            },
            {
                display: '3/5 √ó 10/9',
                type: 'Multiplicaci√≥n con simplificaci√≥n',
                solution: [2, 3],
                hint: 'Puedes simplificar antes de multiplicar: 3 y 9 tienen factor com√∫n, 5 y 10 tambi√©n',
                explanation: 'Podemos simplificar antes de multiplicar: 3/5 √ó 10/9. Cancelamos: 3 y 9 (divido entre 3), 5 y 10 (divido entre 5). Nos queda: 1/1 √ó 2/3 = 2/3.',
                emoji: '‚ö°'
            },
            {
                display: '2/3 √∑ 4',
                type: 'Divisi√≥n entre n√∫mero entero',
                solution: [1, 6],
                hint: 'Convierte 4 a fracci√≥n: 4 = 4/1, luego invierte: 4/1 ‚Üí 1/4, y multiplica',
                explanation: 'Para dividir entre un entero, lo convertimos a fracci√≥n: 4 = 4/1. Invertimos: 1/4. Multiplicamos: 2/3 √ó 1/4 = (2√ó1)/(3√ó4) = 2/12 = 1/6.',
                emoji: 'üìê'
            },
            {
                display: '1/3 + 1/4 + 1/6',
                type: 'Suma de tres fracciones',
                solution: [3, 4],
                hint: 'Busca el denominador com√∫n de 3, 4 y 6. El MCM es 12',
                explanation: 'Encontramos el MCM de 3, 4 y 6, que es 12. Convertimos: 1/3=4/12, 1/4=3/12, 1/6=2/12. Sumamos: 4/12 + 3/12 + 2/12 = 9/12 = 3/4.',
                emoji: 'üßÆ'
            },
            {
                display: '(3/4 - 1/2) √∑ (1/8)',
                type: 'Operaci√≥n compleja con par√©ntesis',
                solution: [2, 1],
                hint: 'Resuelve cada par√©ntesis: (3/4 - 1/2) y luego divide entre 1/8',
                explanation: 'Primero resolvemos: 3/4 - 1/2 = 3/4 - 2/4 = 1/4. Luego dividimos: 1/4 √∑ 1/8 = 1/4 √ó 8/1 = 8/4 = 2. Resultado: 2 (o 2/1).',
                emoji: 'üéØ'
            }
        ];

        function startDigitalPractice() {
            practiceState = {
                currentExercise: 0,
                completed: 0,
                correct: 0,
                exercises: [...practiceExercises],
                started: true,
                showingResult: false
            };

            document.getElementById('practice-mode-selection').classList.add('hidden');
            document.getElementById('digital-practice').classList.remove('hidden');

            showPracticeExercise();
        }

        function showPracticeExercise() {
            if (practiceState.currentExercise >= practiceState.exercises.length) {
                completePractice();
                return;
            }

            const exercise = practiceState.exercises[practiceState.currentExercise];
            const progress = ((practiceState.currentExercise + 1) / practiceState.exercises.length) * 100;

            document.getElementById('practice-progress').textContent = `${practiceState.currentExercise + 1}/10`;
            document.getElementById('practice-progress-bar').style.width = progress + '%';

            document.getElementById('practice-emoji').textContent = exercise.emoji;
            document.getElementById('practice-title').textContent = `Ejercicio ${practiceState.currentExercise + 1}: ${exercise.type}`;
            document.getElementById('practice-exercise').textContent = exercise.display;

            document.getElementById('answer-numerator').value = '';
            document.getElementById('answer-denominator').value = '';

            document.getElementById('practice-hint').classList.add('hidden');
            document.getElementById('practice-result').classList.add('hidden');
            
            document.getElementById('practice-hint-btn').disabled = false;
            document.getElementById('practice-hint-btn').classList.remove('opacity-50');

            practiceState.showingResult = false;
        }

        function checkPracticeAnswer() {
            if (practiceState.showingResult) return;

            const numInput = document.getElementById('answer-numerator');
            const denInput = document.getElementById('answer-denominator');
            
            const userNum = parseInt(numInput.value);
            const userDen = parseInt(denInput.value) || 1;

            if (isNaN(userNum) || userDen <= 0) {
                showCustomAlert('Por favor ingresa n√∫meros v√°lidos');
                return;
            }

            const exercise = practiceState.exercises[practiceState.currentExercise];
            const correctAnswer = exercise.solution;
            
            const userAnswerSimplified = simplifyFraction(userNum, userDen);
            const isCorrect = userAnswerSimplified[0] === correctAnswer[0] && userAnswerSimplified[1] === correctAnswer[1];

            practiceState.showingResult = true;

            document.getElementById('practice-result').classList.remove('hidden');
            
            if (isCorrect) {
                practiceState.correct++;
                document.getElementById('practice-feedback').innerHTML = `
                    <span class="text-green-600">‚úÖ ¬°Correcto! Excelente trabajo</span>
                `;
                createMiniConfetti();
            } else {
                document.getElementById('practice-feedback').innerHTML = `
                    <span class="text-red-600">‚ùå Incorrecto</span><br>
                    <span class="text-blue-600">Respuesta correcta: ${correctAnswer[1] === 1 ? correctAnswer[0] : correctAnswer[0] + '/' + correctAnswer[1]}</span>
                `;
            }

            document.getElementById('practice-explanation').innerHTML = `
                <h6 class="font-bold mb-2">üìö Explicaci√≥n paso a paso:</h6>
                <p class="text-sm">${exercise.explanation}</p>
            `;

            practiceState.completed++;
            updatePracticeStats();
        }

        function showPracticeHint() {
            const exercise = practiceState.exercises[practiceState.currentExercise];
            document.getElementById('practice-hint-text').textContent = exercise.hint;
            document.getElementById('practice-hint').classList.remove('hidden');
            
            document.getElementById('practice-hint-btn').disabled = true;
            document.getElementById('practice-hint-btn').classList.add('opacity-50');
        }

        function skipExercise() {
            if (!practiceState.showingResult) {
                practiceState.completed++;
                updatePracticeStats();
            }
            nextPracticeExercise();
        }

        function nextPracticeExercise() {
            practiceState.currentExercise++;
            
            if (practiceState.currentExercise >= practiceState.exercises.length) {
                completePractice();
            } else {
                showPracticeExercise();
            }
        }

        function completePractice() {
            const accuracy = (practiceState.correct / practiceState.exercises.length) * 100;
            const xpEarned = practiceState.correct * 20 + 100;
            
            addXP(xpEarned);
            addPoints(practiceState.correct * 50);

            document.getElementById('digital-practice').classList.add('hidden');
            document.getElementById('practice-complete').classList.remove('hidden');

            document.getElementById('practice-final-stats').innerHTML = `
                <div class="space-y-3">
                    <p><strong>Ejercicios completados:</strong> ${practiceState.exercises.length}/10</p>
                    <p><strong>Respuestas correctas:</strong> ${practiceState.correct}/10</p>
                    <p><strong>Precisi√≥n:</strong> ${accuracy.toFixed(1)}%</p>
                    <p class="text-green-600 font-bold"><strong>XP ganado:</strong> +${xpEarned}</p>
                    <div class="text-3xl mt-4">
                        ${accuracy >= 90 ? 'üèÜ ¬°Maestro absoluto!' : 
                          accuracy >= 80 ? '‚≠ê ¬°Excelente dominio!' : 
                          accuracy >= 70 ? 'üéØ ¬°Muy buen trabajo!' : 
                          accuracy >= 60 ? 'üëç ¬°Buen progreso!' : 'üí™ ¬°Sigue practicando!'}
                    </div>
                </div>
            `;

            createConfetti();
            showNotification(`üéâ Pr√°ctica completada: +${xpEarned} XP!`, 'success');
        }

        function updatePracticeStats() {
            const accuracy = practiceState.completed > 0 ? (practiceState.correct / practiceState.completed) * 100 : 0;
            const xpEarned = practiceState.correct * 20;

            document.getElementById('practice-completed').textContent = practiceState.completed;
            document.getElementById('practice-correct').textContent = practiceState.correct;
            document.getElementById('practice-accuracy').textContent = accuracy.toFixed(1) + '%';
            document.getElementById('practice-xp').textContent = xpEarned;
        }

        function exitPractice() {
            document.getElementById('practice-mode-selection').classList.remove('hidden');
            document.getElementById('digital-practice').classList.add('hidden');
            document.getElementById('practice-complete').classList.add('hidden');
            
            practiceState.started = false;
        }

        function resetPracticeSection() {
            document.getElementById('practice-mode-selection').classList.remove('hidden');
            document.getElementById('digital-practice').classList.add('hidden');
            document.getElementById('practice-complete').classList.add('hidden');
            
            practiceState = {
                currentExercise: 0,
                completed: 0,
                correct: 0,
                exercises: [],
                started: false,
                showingResult: false
            };
            
            document.getElementById('practice-completed').textContent = '0';
            document.getElementById('practice-correct').textContent = '0';
            document.getElementById('practice-accuracy').textContent = '0%';
            document.getElementById('practice-xp').textContent = '0';
        }

        // Worksheet Generation System
        function generateWorksheet() {
            const worksheetExercises = generateWorksheetExercises();
            const worksheetHTML = createWorksheetHTML(worksheetExercises);
            
            document.getElementById('worksheet-content').innerHTML = worksheetHTML;
            document.getElementById('worksheet-modal').classList.remove('hidden');
        }

        function generateWorksheetExercises() {
            const exercises = [];
            const types = [
                { type: 'add_different', name: 'Suma con denominadores diferentes', count: 2 },
                { type: 'subtract_butterfly', name: 'Resta con m√©todo mariposa', count: 2 },
                { type: 'multiply_direct', name: 'Multiplicaci√≥n directa', count: 2 },
                { type: 'divide_invert', name: 'Divisi√≥n (invertir y multiplicar)', count: 1 },
                { type: 'combined_operations', name: 'Operaciones combinadas', count: 2 },
                { type: 'three_fractions', name: 'Suma de tres fracciones', count: 1 }
            ];

            types.forEach(category => {
                for (let i = 0; i < category.count; i++) {
                    exercises.push(generateExerciseByType(category.type, category.name));
                }
            });

            return exercises;
        }

        function generateExerciseByType(type, typeName) {
            let exercise = { type: typeName };
            
            switch(type) {
                case 'add_different':
                    const num1 = Math.floor(Math.random() * 5) + 1;
                    const den1 = Math.floor(Math.random() * 8) + 2;
                    const num2 = Math.floor(Math.random() * 5) + 1;
                    const den2 = Math.floor(Math.random() * 8) + 2;
                    
                    if (den1 !== den2) {
                        exercise.problem = `${num1}/${den1} + ${num2}/${den2}`;
                        exercise.solution = simplifyFraction((num1 * den2) + (num2 * den1), den1 * den2);
                    } else {
                        exercise.problem = `${num1}/${den1} + ${num2}/${den2 + 1}`;
                        exercise.solution = simplifyFraction((num1 * (den2 + 1)) + (num2 * den1), den1 * (den2 + 1));
                    }
                    break;

                case 'subtract_butterfly':
                    const sNum1 = Math.floor(Math.random() * 7) + 2;
                    const sDen1 = Math.floor(Math.random() * 6) + 2;
                    const sNum2 = Math.floor(Math.random() * 5) + 1;
                    const sDen2 = Math.floor(Math.random() * 6) + 2;
                    
                    if ((sNum1 * sDen2) >= (sNum2 * sDen1)) {
                        exercise.problem = `${sNum1}/${sDen1} - ${sNum2}/${sDen2}`;
                        exercise.solution = simplifyFraction((sNum1 * sDen2) - (sNum2 * sDen1), sDen1 * sDen2);
                    } else {
                        exercise.problem = `${sNum2}/${sDen2} - ${sNum1}/${sDen1}`;
                        exercise.solution = simplifyFraction((sNum2 * sDen1) - (sNum1 * sDen2), sDen1 * sDen2);
                    }
                    break;

                case 'multiply_direct':
                    const mNum1 = Math.floor(Math.random() * 6) + 1;
                    const mDen1 = Math.floor(Math.random() * 8) + 2;
                    const mNum2 = Math.floor(Math.random() * 6) + 1;
                    const mDen2 = Math.floor(Math.random() * 8) + 2;
                    
                    exercise.problem = `${mNum1}/${mDen1} √ó ${mNum2}/${mDen2}`;
                    exercise.solution = simplifyFraction(mNum1 * mNum2, mDen1 * mDen2);
                    break;

                case 'divide_invert':
                    const dNum1 = Math.floor(Math.random() * 6) + 1;
                    const dDen1 = Math.floor(Math.random() * 8) + 2;
                    const dNum2 = Math.floor(Math.random() * 5) + 1;
                    const dDen2 = Math.floor(Math.random() * 6) + 2;
                    
                    exercise.problem = `${dNum1}/${dDen1} √∑ ${dNum2}/${dDen2}`;
                    exercise.solution = simplifyFraction(dNum1 * dDen2, dDen1 * dNum2);
                    break;

                case 'combined_operations':
                    const operations = [
                        () => {
                            const a = Math.floor(Math.random() * 3) + 1;
                            const b = Math.floor(Math.random() * 6) + 2;
                            const c = Math.floor(Math.random() * 3) + 1;
                            const d = Math.floor(Math.random() * 6) + 2;
                            const e = Math.floor(Math.random() * 4) + 2;
                            
                            return {
                                problem: `(${a}/${b} + ${c}/${d}) √ó ${e}`,
                                solution: (() => {
                                    const sum = simplifyFraction((a * d) + (c * b), b * d);
                                    return simplifyFraction(sum[0] * e, sum[1]);
                                })()
                            };
                        },
                        () => {
                            const a = Math.floor(Math.random() * 5) + 2;
                            const b = Math.floor(Math.random() * 6) + 2;
                            const c = Math.floor(Math.random() * 3) + 1;
                            const d = Math.floor(Math.random() * 6) + 2;
                            
                            return {
                                problem: `${a}/${b} - (${c}/${d} √ó 2)`,
                                solution: (() => {
                                    const product = simplifyFraction(c * 2, d);
                                    return simplifyFraction((a * product[1]) - (product[0] * b), b * product[1]);
                                })()
                            };
                        }
                    ];
                    
                    const selectedOp = operations[Math.floor(Math.random() * operations.length)]();
                    exercise.problem = selectedOp.problem;
                    exercise.solution = selectedOp.solution;
                    break;

                case 'three_fractions':
                    const t1 = Math.floor(Math.random() * 3) + 1;
                    const td1 = Math.floor(Math.random() * 5) + 3;
                    const t2 = Math.floor(Math.random() * 3) + 1;
                    const td2 = Math.floor(Math.random() * 5) + 3;
                    const t3 = Math.floor(Math.random() * 3) + 1;
                    const td3 = Math.floor(Math.random() * 5) + 3;
                    
                    exercise.problem = `${t1}/${td1} + ${t2}/${td2} + ${t3}/${td3}`;
                    const sum1 = simplifyFraction((t1 * td2) + (t2 * td1), td1 * td2);
                    exercise.solution = simplifyFraction((sum1[0] * td3) + (t3 * sum1[1]), sum1[1] * td3);
                    break;
            }
            
            return exercise;
        }

        function createWorksheetHTML(exercises) {
            const currentDate = new Date().toLocaleDateString('es-ES');
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: white; color: black;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #5D5CDE; padding-bottom: 20px;">
                        <h1 style="font-size: 28px; color: #5D5CDE; margin-bottom: 10px;">üéÆ Fracci√≥n Quest - Hoja de Pr√°ctica</h1>
                        <h2 style="font-size: 18px; color: #666; margin-bottom: 15px;">Ejercicios Mixtos de Fracciones</h2>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #888;">
                            <span>Fecha: ${currentDate}</span>
                            <span>Nombre: ________________________</span>
                            <span>Puntuaci√≥n: ____/10</span>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                        <h3 style="color: #5D5CDE; margin-bottom: 10px;">üìã Instrucciones:</h3>
                        <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.6;">
                            <li>Resuelve cada ejercicio paso a paso</li>
                            <li>Simplifica todas las fracciones al resultado final</li>
                            <li>Si el resultado es una fracci√≥n impropia, puedes convertirla a n√∫mero mixto</li>
                            <li>Usa el espacio en blanco para mostrar tu trabajo</li>
                            <li>Recuerda: para denominadores diferentes usa el m√©todo mariposa</li>
                        </ul>
                    </div>

                    <div style="display: grid; gap: 25px;">
                        ${exercises.map((exercise, index) => `
                            <div style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: #5D5CDE; margin: 0; font-size: 16px;">Ejercicio ${index + 1}</h4>
                                    <span style="background: #e5e7eb; padding: 5px 10px; border-radius: 15px; font-size: 12px; color: #666;">${exercise.type}</span>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                                        ${exercise.problem} = ________________
                                    </div>
                                </div>
                                
                                <div style="border-top: 1px solid #e5e7eb; padding-top: 15px;">
                                    <p style="margin: 0; font-size: 12px; color: #666;">Espacio para el desarrollo:</p>
                                    <div style="min-height: 60px; border: 1px dashed #ccc; margin-top: 5px; padding: 10px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-top: 30px; border-top: 2px solid #5D5CDE; padding-top: 20px;">
                        <h3 style="color: #5D5CDE; margin-bottom: 15px;">üìñ Recordatorio de M√©todos:</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 12px;">
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #0369a1; margin-bottom: 8px;">‚ûï‚ûñ Suma y Resta</h4>
                                <p><strong>Denominadores iguales:</strong> Suma/resta numeradores</p>
                                <p><strong>Denominadores diferentes:</strong> M√©todo mariposa</p>
                                <p style="text-align: center; font-family: monospace;">a/b ¬± c/d = (a√ód ¬± c√ób)/(b√ód)</p>
                            </div>
                            <div style="background: #fef3f2; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #dc2626; margin-bottom: 8px;">‚úñÔ∏è‚ûó Multiplicaci√≥n y Divisi√≥n</h4>
                                <p><strong>Multiplicaci√≥n:</strong> a/b √ó c/d = (a√óc)/(b√ód)</p>
                                <p><strong>Divisi√≥n:</strong> a/b √∑ c/d = a/b √ó d/c</p>
                                <p><em>Tip: Simplifica antes de multiplicar</em></p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                        <p>üéÆ Generado por Fracci√≥n Quest - Tu aventura matem√°tica contin√∫a en digital</p>
                        <p>Para m√°s pr√°ctica interactiva, regresa a la aplicaci√≥n web</p>
                    </div>
                </div>
            `;
        }

        function printWorksheet() {
            const printWindow = window.open('', '_blank');
            const worksheetContent = document.getElementById('worksheet-content').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Fracci√≥n Quest - Hoja de Pr√°ctica</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            @page { size: A4; margin: 0.5in; }
                        }
                    </style>
                </head>
                <body>
                    ${worksheetContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function downloadWorksheet() {
            const exercises = generateWorksheetExercises();
            const worksheetHTML = createDownloadableWorksheet(exercises);
            
            const blob = new Blob([worksheetHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fraccion-quest-ejercicios-${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function createDownloadableWorksheet(exercises) {
            const currentDate = new Date().toLocaleDateString('es-ES');
            
            return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fracci√≥n Quest - Hoja de Pr√°ctica</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: white; color: black; }
        .exercise { border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #5D5CDE; padding-bottom: 20px; }
        .instructions { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 25px; }
        @media print { 
            body { margin: 0; }
            @page { size: A4; margin: 0.5in; }
        }
    </style>
</head>
<body>
    ${createWorksheetHTML(exercises)}
</body>
</html>`;
        }

        function generateNewWorksheet() {
            const newExercises = generateWorksheetExercises();
            const newWorksheetHTML = createWorksheetHTML(newExercises);
            
            document.getElementById('worksheet-content').innerHTML = newWorksheetHTML;
            
            showNotification('üìÑ ¬°Nueva hoja generada con ejercicios diferentes!', 'success');
        }

        function closeWorksheet() {
            document.getElementById('worksheet-modal').classList.add('hidden');
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Utility Functions
        function addXP(amount) {
            gameState.xp += amount;
            
            const xpNeeded = gameState.level * 100;
            if (gameState.xp >= xpNeeded) {
                levelUp();
            }
            
            updateUI();
            showXPGain(amount);
        }

        function levelUp() {
            gameState.level++;
            gameState.xp = 0;
            
            createConfetti();
            showNotification(`üéâ ¬°Nivel ${gameState.level}! ¬°Incre√≠ble progreso!`, 'success');
        }

        function addPoints(amount) {
            gameState.totalPoints += amount;
            updateUI();
        }

        function simplifyFraction(num, den) {
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const divisor = gcd(Math.abs(num), Math.abs(den));
            return [num / divisor, den / divisor];
        }

        function createConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function createMiniConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#4ade80', '#22c55e', '#16a34a'];
            
            for (let i = 0; i < 15; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function showXPGain(amount) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 py-2 rounded-xl shadow-lg z-50 animate-pop';
            notification.textContent = `+${amount} XP`;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 2000);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgClass = type === 'success' ? 'from-green-500 to-emerald-500' : 'from-blue-500 to-purple-500';
            
            notification.className = `fixed top-4 right-4 bg-gradient-to-r ${bgClass} text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-pop max-w-sm`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        function updateUI() {
            document.getElementById('player-level').textContent = gameState.level;
            document.getElementById('current-xp').textContent = gameState.xp;
            document.getElementById('max-xp').textContent = gameState.level * 100;
            document.getElementById('total-points').textContent = gameState.totalPoints;
            document.getElementById('streak-count').textContent = gameState.streak;
            document.getElementById('achievement-count').textContent = gameState.achievements.length;
            document.getElementById('space-missions').textContent = gameState.spaceMissions;
            document.getElementById('crystals-collected').textContent = gameState.crystals;
            document.getElementById('current-galaxy').textContent = `Galaxia ${gameState.currentGalaxy}`;
            document.getElementById('ship-level').textContent = `Nave Nivel ${gameState.shipLevel}`;
            document.getElementById('energy-level').textContent = `${gameState.energy}%`;
            
            const xpPercentage = (gameState.xp / (gameState.level * 100)) * 100;
            document.getElementById('xp-bar').style.width = xpPercentage + '%';
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Visual Tab System
        function showVisualTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.visual-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Update button styles
            document.querySelectorAll('.visual-tab-btn').forEach(btn => {
                btn.className = 'visual-tab-btn bg-gray-300 dark:bg-gray-600 px-6 py-3 rounded-2xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-300 transform hover:scale-105 shadow-lg';
            });
            
            // Highlight active button
            event.target.className = 'visual-tab-btn bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-6 py-3 rounded-2xl hover:from-blue-600 hover:to-cyan-700 transition-all duration-300 transform hover:scale-105 shadow-lg';
        }

        // Operations Visualizer
        function visualizeOperation() {
            const num1 = parseInt(document.getElementById('op-num1').value);
            const den1 = parseInt(document.getElementById('op-den1').value);
            const num2 = parseInt(document.getElementById('op-num2').value);
            const den2 = parseInt(document.getElementById('op-den2').value);
            const operation = document.getElementById('operation-type').value;

            if (!num1 || !den1 || !num2 || !den2 || den1 <= 0 || den2 <= 0) {
                showCustomAlert('Por favor ingresa n√∫meros v√°lidos');
                return;
            }

            // Create visual representation
            const visualDisplay = document.getElementById('visual-display');
            visualDisplay.innerHTML = createFractionVisual(num1, den1, num2, den2, operation);

            // Show step-by-step solution
            document.getElementById('step-solution').classList.remove('hidden');
            document.getElementById('solution-steps').innerHTML = createSolutionSteps(num1, den1, num2, den2, operation);
        }

        function createFractionVisual(num1, den1, num2, den2, operation) {
            const symbols = {
                'add': '+',
                'subtract': '-',
                'multiply': '√ó',
                'divide': '√∑'
            };

            return `
                <div class="space-y-6">
                    <div class="flex justify-center items-center gap-4">
                        ${createCircularFraction(num1, den1, '#3B82F6')}
                        <span class="text-4xl font-bold">${symbols[operation]}</span>
                        ${createCircularFraction(num2, den2, '#EF4444')}
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold mb-2">Representaci√≥n Visual</div>
                        <div class="text-sm text-gray-600">
                            Fracci√≥n azul: ${num1}/${den1} ‚Ä¢ Fracci√≥n roja: ${num2}/${den2}
                        </div>
                    </div>
                </div>
            `;
        }

        function createCircularFraction(numerator, denominator, color) {
            const slices = [];
            const anglePerSlice = 360 / denominator;
            
            for (let i = 0; i < denominator; i++) {
                const startAngle = i * anglePerSlice;
                const endAngle = (i + 1) * anglePerSlice;
                const filled = i < numerator;
                
                slices.push(`
                    <path d="M 50 50 L ${50 + 40 * Math.cos((startAngle - 90) * Math.PI / 180)} ${50 + 40 * Math.sin((startAngle - 90) * Math.PI / 180)} A 40 40 0 0 1 ${50 + 40 * Math.cos((endAngle - 90) * Math.PI / 180)} ${50 + 40 * Math.sin((endAngle - 90) * Math.PI / 180)} Z"
                          fill="${filled ? color : '#E5E7EB'}"
                          stroke="white"
                          stroke-width="2"/>
                `);
            }

            return `
                <div class="flex flex-col items-center">
                    <svg width="100" height="100" viewBox="0 0 100 100">
                        ${slices.join('')}
                    </svg>
                    <div class="mt-2 text-lg font-bold">${numerator}/${denominator}</div>
                </div>
            `;
        }

        function createSolutionSteps(num1, den1, num2, den2, operation) {
            let result, stepsData = [];
            
            switch(operation) {
                case 'add':
                    if (den1 === den2) {
                        result = simplifyFraction(num1 + num2, den1);
                        stepsData = [
                            {
                                title: "üü∞ Denominadores Iguales - ¬°S√∫per F√°cil!",
                                content: `Como ambos denominadores son <strong class="text-blue-600">${den1}</strong>, solo sumamos los numeradores.`,
                                color: "from-green-100 to-emerald-100",
                                darkColor: "from-green-900/30 to-emerald-900/30",
                                icon: "‚úÖ"
                            },
                            {
                                title: "üßÆ Operaci√≥n de Numeradores",
                                content: `<div class="text-center text-2xl font-bold mb-2">
                                    <span class="text-red-600">${num1}</span> + <span class="text-red-600">${num2}</span> = <span class="text-green-600">${num1 + num2}</span>
                                </div>`,
                                color: "from-blue-100 to-cyan-100",
                                darkColor: "from-blue-900/30 to-cyan-900/30",
                                icon: "‚ûï"
                            },
                            {
                                title: "üéØ Resultado Inicial",
                                content: `<div class="text-center">
                                    <div class="fraction text-3xl mb-3">
                                        <span class="numerator text-green-600 font-bold">${num1 + num2}</span>
                                        <span class="denominator text-blue-600 font-bold">${den1}</span>
                                    </div>
                                    <p class="text-sm">Mantenemos el denominador original</p>
                                </div>`,
                                color: "from-yellow-100 to-orange-100",
                                darkColor: "from-yellow-900/30 to-orange-900/30",
                                icon: "üé™"
                            }
                        ];
                        
                        if (result[0] !== (num1 + num2) || result[1] !== den1) {
                            stepsData.push({
                                title: "üîß Simplificaci√≥n Final",
                                content: `<div class="text-center">
                                    <div class="text-lg mb-3">
                                        <span class="fraction text-xl">
                                            <span class="numerator">${num1 + num2}</span>
                                            <span class="denominator">${den1}</span>
                                        </span>
                                        <span class="mx-3 text-2xl">‚Üí</span>
                                        <span class="fraction text-xl">
                                            <span class="numerator text-purple-600 font-bold">${result[0]}</span>
                                            <span class="denominator text-purple-600 font-bold">${result[1]}</span>
                                        </span>
                                    </div>
                                    <p class="text-sm">Dividimos numerador y denominador entre su MCD</p>
                                </div>`,
                                color: "from-purple-100 to-pink-100",
                                darkColor: "from-purple-900/30 to-pink-900/30",
                                icon: "‚ú®"
                            });
                        }
                    } else {
                        const newNum = (num1 * den2) + (num2 * den1);
                        const newDen = den1 * den2;
                        result = simplifyFraction(newNum, newDen);
                        
                        stepsData = [
                            {
                                title: "ü¶ã M√©todo Mariposa - Denominadores Diferentes",
                                content: `Los denominadores son diferentes (<strong>${den1}</strong> ‚â† <strong>${den2}</strong>), as√≠ que usamos el m√©todo mariposa.`,
                                color: "from-orange-100 to-yellow-100",
                                darkColor: "from-orange-900/30 to-yellow-900/30",
                                icon: "üîÑ"
                            },
                            {
                                title: "ü¶ã Visualizaci√≥n del M√©todo Mariposa",
                                content: `
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl mb-6">
                                        <h5 class="text-center text-xl font-bold mb-6 text-purple-600">¬°Observa c√≥mo vuelan las l√≠neas como una mariposa! ü¶ã</h5>
                                        
                                        <!-- Diagrama de la Mariposa -->
                                        <div class="relative mx-auto w-80 h-48 mb-6">
                                            <svg width="320" height="192" viewBox="0 0 320 192" class="absolute inset-0">
                                                <!-- L√≠neas de la mariposa -->
                                                <line x1="80" y1="60" x2="240" y2="132" stroke="#3B82F6" stroke-width="3" class="butterfly-line-1">
                                                    <animate attributeName="stroke-dasharray" values="0,1000;1000,0" dur="2s" begin="0s" fill="freeze"/>
                                                </line>
                                                <line x1="80" y1="132" x2="240" y2="60" stroke="#EF4444" stroke-width="3" class="butterfly-line-2">
                                                    <animate attributeName="stroke-dasharray" values="0,1000;1000,0" dur="2s" begin="1s" fill="freeze"/>
                                                </line>
                                                
                                                <!-- C√≠rculos en los extremos -->
                                                <circle cx="80" cy="60" r="8" fill="#3B82F6" class="animate-pulse"/>
                                                <circle cx="80" cy="132" r="8" fill="#DC2626" class="animate-pulse"/>
                                                <circle cx="240" cy="60" r="8" fill="#EF4444" class="animate-pulse"/>
                                                <circle cx="240" cy="132" r="8" fill="#1D4ED8" class="animate-pulse"/>
                                            </svg>
                                            
                                            <!-- Fracciones posicionadas -->
                                            <div class="absolute left-4 top-8 bg-blue-100 dark:bg-blue-900/30 px-3 py-2 rounded-lg border-2 border-blue-300">
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-blue-600">${num1}</div>
                                                    <div class="border-b-2 border-blue-600 mb-1"></div>
                                                    <div class="text-2xl font-bold text-red-600">${den1}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="absolute right-4 top-8 bg-red-100 dark:bg-red-900/30 px-3 py-2 rounded-lg border-2 border-red-300">
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-red-600">${num2}</div>
                                                    <div class="border-b-2 border-red-600 mb-1"></div>
                                                    <div class="text-2xl font-bold text-blue-600">${den2}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Indicadores de multiplicaci√≥n -->
                                            <div class="absolute top-16 left-28 bg-yellow-200 dark:bg-yellow-800 px-2 py-1 rounded text-sm font-bold text-purple-600 animate-bounce">
                                                ${num1} √ó ${den2}
                                            </div>
                                            <div class="absolute bottom-16 left-28 bg-yellow-200 dark:bg-yellow-800 px-2 py-1 rounded text-sm font-bold text-purple-600 animate-bounce" style="animation-delay: 0.5s">
                                                ${num2} √ó ${den1}
                                            </div>
                                        </div>
                                        
                                        <!-- Explicaci√≥n del patr√≥n -->
                                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-4 rounded-xl">
                                            <h6 class="font-bold text-purple-600 mb-3">üîç ¬øPor qu√© se llama "M√©todo Mariposa"?</h6>
                                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <p class="mb-2"><strong>ü¶ã Las alas de la mariposa:</strong></p>
                                                    <ul class="space-y-1 text-xs">
                                                        <li>‚Ä¢ <span class="text-blue-600">L√≠nea azul</span>: conecta ${num1} con ${den2}</li>
                                                        <li>‚Ä¢ <span class="text-red-600">L√≠nea roja</span>: conecta ${num2} con ${den1}</li>
                                                        <li>‚Ä¢ ¬°Las l√≠neas cruzadas forman las alas!</li>
                                                    </ul>
                                                </div>
                                                <div>
                                                    <p class="mb-2"><strong>‚ö° El patr√≥n m√°gico:</strong></p>
                                                    <ul class="space-y-1 text-xs">
                                                        <li>‚Ä¢ Multiplicas "en cruz" o "en X"</li>
                                                        <li>‚Ä¢ Cada l√≠nea te da un n√∫mero</li>
                                                        <li>‚Ä¢ ¬°Simple y f√°cil de recordar!</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Resultado de las multiplicaciones -->
                                    <div class="grid grid-cols-2 gap-4 mt-6">
                                        <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-2 border-blue-300">
                                            <div class="text-lg font-bold text-blue-600 mb-2">ü¶ã Ala Izquierda</div>
                                            <div class="text-2xl font-bold">${num1} √ó ${den2} = <span class="text-green-600">${num1 * den2}</span></div>
                                            <div class="text-sm text-gray-600 mt-1">Numerador 1 √ó Denominador 2</div>
                                        </div>
                                        <div class="text-center p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-2 border-red-300">
                                            <div class="text-lg font-bold text-red-600 mb-2">ü¶ã Ala Derecha</div>
                                            <div class="text-2xl font-bold">${num2} √ó ${den1} = <span class="text-green-600">${num2 * den1}</span></div>
                                            <div class="text-sm text-gray-600 mt-1">Numerador 2 √ó Denominador 1</div>
                                        </div>
                                    </div>
                                `,
                                color: "from-indigo-100 to-purple-100",
                                darkColor: "from-indigo-900/30 to-purple-900/30",
                                icon: "ü¶ã"
                            },
                            {
                                title: "‚ûï Suma de Cruces",
                                content: `<div class="text-center text-2xl font-bold mb-2">
                                    <span class="text-green-600">${num1 * den2}</span> + <span class="text-green-600">${num2 * den1}</span> = <span class="text-purple-600">${newNum}</span>
                                </div>
                                <p class="text-center text-sm">Este ser√° nuestro nuevo numerador</p>`,
                                color: "from-green-100 to-teal-100",
                                darkColor: "from-green-900/30 to-teal-900/30",
                                icon: "üßÆ"
                            },
                            {
                                title: "üî¢ Nuevo Denominador",
                                content: `<div class="text-center text-2xl font-bold mb-2">
                                    <span class="text-blue-600">${den1}</span> √ó <span class="text-blue-600">${den2}</span> = <span class="text-purple-600">${newDen}</span>
                                </div>
                                <p class="text-center text-sm">Multiplicamos los denominadores originales</p>`,
                                color: "from-cyan-100 to-blue-100",
                                darkColor: "from-cyan-900/30 to-blue-900/30",
                                icon: "‚úñÔ∏è"
                            },
                            {
                                title: "üéØ Resultado del M√©todo Mariposa",
                                content: `<div class="text-center">
                                    <div class="fraction text-3xl mb-3">
                                        <span class="numerator text-purple-600 font-bold">${newNum}</span>
                                        <span class="denominator text-purple-600 font-bold">${newDen}</span>
                                    </div>
                                    <p class="text-sm">Fracci√≥n obtenida con el m√©todo mariposa</p>
                                </div>`,
                                color: "from-yellow-100 to-orange-100",
                                darkColor: "from-yellow-900/30 to-orange-900/30",
                                icon: "üé™"
                            }
                        ];
                        
                        if (result[0] !== newNum || result[1] !== newDen) {
                            stepsData.push({
                                title: "üîß Simplificaci√≥n Final",
                                content: `<div class="text-center">
                                    <div class="text-lg mb-3">
                                        <span class="fraction text-xl">
                                            <span class="numerator">${newNum}</span>
                                            <span class="denominator">${newDen}</span>
                                        </span>
                                        <span class="mx-3 text-2xl">‚Üí</span>
                                        <span class="fraction text-xl">
                                            <span class="numerator text-green-600 font-bold">${result[0]}</span>
                                            <span class="denominator text-green-600 font-bold">${result[1]}</span>
                                        </span>
                                    </div>
                                    <p class="text-sm">Simplificamos dividiendo entre el MCD</p>
                                </div>`,
                                color: "from-emerald-100 to-green-100",
                                darkColor: "from-emerald-900/30 to-green-900/30",
                                icon: "‚ú®"
                            });
                        }
                    }
                    break;

                case 'subtract':
                    if (den1 === den2) {
                        result = simplifyFraction(Math.abs(num1 - num2), den1);
                        const larger = Math.max(num1, num2);
                        const smaller = Math.min(num1, num2);
                        
                        stepsData = [
                            {
                                title: "üü∞ Denominadores Iguales - ¬°S√∫per F√°cil!",
                                content: `Como ambos denominadores son <strong class="text-blue-600">${den1}</strong>, solo restamos los numeradores.`,
                                color: "from-green-100 to-emerald-100",
                                darkColor: "from-green-900/30 to-emerald-900/30",
                                icon: "‚úÖ"
                            },
                            {
                                title: "‚ûñ Operaci√≥n de Numeradores",
                                content: `<div class="text-center text-2xl font-bold mb-2">
                                    <span class="text-red-600">${larger}</span> - <span class="text-red-600">${smaller}</span> = <span class="text-green-600">${Math.abs(num1 - num2)}</span>
                                </div>
                                <p class="text-center text-sm">Restamos el menor del mayor</p>`,
                                color: "from-red-100 to-pink-100",
                                darkColor: "from-red-900/30 to-pink-900/30",
                                icon: "‚ûñ"
                            },
                            {
                                title: "üéØ Resultado Final",
                                content: `<div class="text-center">
                                    <div class="fraction text-3xl mb-3">
                                        <span class="numerator text-green-600 font-bold">${Math.abs(num1 - num2)}</span>
                                        <span class="denominator text-blue-600 font-bold">${den1}</span>
                                    </div>
                                    <p class="text-sm">Mantenemos el denominador original</p>
                                </div>`,
                                color: "from-yellow-100 to-orange-100",
                                darkColor: "from-yellow-900/30 to-orange-900/30",
                                icon: "üé™"
                            }
                        ];
                    } else {
                        const newNum = Math.abs((num1 * den2) - (num2 * den1));
                        const newDen = den1 * den2;
                        result = simplifyFraction(newNum, newDen);
                        
                        stepsData = [
                            {
                                title: "ü¶ã M√©todo Mariposa - Denominadores Diferentes",
                                content: `Los denominadores son diferentes (<strong>${den1}</strong> ‚â† <strong>${den2}</strong>), usamos el m√©todo mariposa.`,
                                color: "from-orange-100 to-yellow-100",
                                darkColor: "from-orange-900/30 to-yellow-900/30",
                                icon: "üîÑ"
                            },
                            {
                                title: "üéØ Cruces del M√©todo Mariposa",
                                content: `<div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                        <div class="text-lg font-bold text-red-600">Cruz 1:</div>
                                        <div class="text-xl">${num1} √ó ${den2} = <span class="font-bold text-green-600">${num1 * den2}</span></div>
                                    </div>
                                    <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                        <div class="text-lg font-bold text-blue-600">Cruz 2:</div>
                                        <div class="text-xl">${num2} √ó ${den1} = <span class="font-bold text-green-600">${num2 * den1}</span></div>
                                    </div>
                                </div>`,
                                color: "from-indigo-100 to-purple-100",
                                darkColor: "from-indigo-900/30 to-purple-900/30",
                                icon: "üé™"
                            },
                            {
                                title: "‚ûñ Resta de Cruces",
                                content: `<div class="text-center text-2xl font-bold mb-2">
                                    |<span class="text-green-600">${num1 * den2}</span> - <span class="text-green-600">${num2 * den1}</span>| = <span class="text-purple-600">${newNum}</span>
                                </div>
                                <p class="text-center text-sm">Usamos valor absoluto para evitar negativos</p>`,
                                color: "from-red-100 to-pink-100",
                                darkColor: "from-red-900/30 to-pink-900/30",
                                icon: "üßÆ"
                            },
                            {
                                title: "üéØ Resultado Final",
                                content: `<div class="text-center">
                                    <div class="fraction text-3xl mb-3">
                                        <span class="numerator text-purple-600 font-bold">${newNum}</span>
                                        <span class="denominator text-purple-600 font-bold">${newDen}</span>
                                    </div>
                                </div>`,
                                color: "from-yellow-100 to-orange-100",
                                darkColor: "from-yellow-900/30 to-orange-900/30",
                                icon: "üé™"
                            }
                        ];
                    }
                    break;

                case 'multiply':
                    const mulNum = num1 * num2;
                    const mulDen = den1 * den2;
                    result = simplifyFraction(mulNum, mulDen);
                    
                    stepsData = [
                        {
                            title: "‚úñÔ∏è Multiplicaci√≥n Directa - ¬°S√∫per F√°cil!",
                            content: `La multiplicaci√≥n de fracciones es la operaci√≥n m√°s sencilla. Solo multiplicamos en l√≠nea recta.`,
                            color: "from-green-100 to-emerald-100",
                            darkColor: "from-green-900/30 to-emerald-900/30",
                            icon: "üöÄ"
                        },
                        {
                            title: "üî¢ Multiplicaci√≥n de Numeradores",
                            content: `<div class="text-center text-2xl font-bold mb-2">
                                <span class="text-red-600">${num1}</span> √ó <span class="text-red-600">${num2}</span> = <span class="text-green-600">${mulNum}</span>
                            </div>
                            <p class="text-center text-sm">Multiplicamos los n√∫meros de arriba</p>`,
                            color: "from-red-100 to-pink-100",
                            darkColor: "from-red-900/30 to-pink-900/30",
                            icon: "‚¨ÜÔ∏è"
                        },
                        {
                            title: "üî¢ Multiplicaci√≥n de Denominadores",
                            content: `<div class="text-center text-2xl font-bold mb-2">
                                <span class="text-blue-600">${den1}</span> √ó <span class="text-blue-600">${den2}</span> = <span class="text-purple-600">${mulDen}</span>
                            </div>
                            <p class="text-center text-sm">Multiplicamos los n√∫meros de abajo</p>`,
                            color: "from-blue-100 to-cyan-100",
                            darkColor: "from-blue-900/30 to-cyan-900/30",
                            icon: "‚¨áÔ∏è"
                        },
                        {
                            title: "üéØ Resultado de la Multiplicaci√≥n",
                            content: `<div class="text-center">
                                <div class="fraction text-3xl mb-3">
                                    <span class="numerator text-green-600 font-bold">${mulNum}</span>
                                    <span class="denominator text-purple-600 font-bold">${mulDen}</span>
                                </div>
                                <p class="text-sm">Resultado directo de la multiplicaci√≥n</p>
                            </div>`,
                            color: "from-yellow-100 to-orange-100",
                            darkColor: "from-yellow-900/30 to-orange-900/30",
                            icon: "üé™"
                        }
                    ];
                    
                    if (result[0] !== mulNum || result[1] !== mulDen) {
                        stepsData.push({
                            title: "üîß Simplificaci√≥n Final",
                            content: `<div class="text-center">
                                <div class="text-lg mb-3">
                                    <span class="fraction text-xl">
                                        <span class="numerator">${mulNum}</span>
                                        <span class="denominator">${mulDen}</span>
                                    </span>
                                    <span class="mx-3 text-2xl">‚Üí</span>
                                    <span class="fraction text-xl">
                                        <span class="numerator text-green-600 font-bold">${result[0]}</span>
                                        <span class="denominator text-green-600 font-bold">${result[1]}</span>
                                    </span>
                                </div>
                                <p class="text-sm">¬°Siempre simplificamos al final!</p>
                            </div>`,
                            color: "from-emerald-100 to-green-100",
                            darkColor: "from-emerald-900/30 to-green-900/30",
                            icon: "‚ú®"
                        });
                    }
                    break;

                case 'divide':
                    const divNum = num1 * den2;
                    const divDen = den1 * num2;
                    result = simplifyFraction(divNum, divDen);
                    
                    stepsData = [
                        {
                            title: "‚ûó Divisi√≥n: Invertir y Multiplicar",
                            content: `Para dividir fracciones, invertimos la segunda fracci√≥n y cambiamos √∑ por √ó. ¬°Es como magia!`,
                            color: "from-cyan-100 to-blue-100",
                            darkColor: "from-cyan-900/30 to-blue-900/30",
                            icon: "üé©"
                        },
                        {
                            title: "üîÑ Inversi√≥n de la Segunda Fracci√≥n",
                            content: `<div class="text-center">
                                <div class="text-xl mb-3">
                                    <span class="fraction">
                                        <span class="numerator text-red-600">${num2}</span>
                                        <span class="denominator text-blue-600">${den2}</span>
                                    </span>
                                    <span class="mx-3 text-2xl">‚Üí</span>
                                    <span class="fraction">
                                        <span class="numerator text-blue-600 font-bold">${den2}</span>
                                        <span class="denominator text-red-600 font-bold">${num2}</span>
                                    </span>
                                </div>
                                <p class="text-sm">¬°Volteamos la segunda fracci√≥n!</p>
                            </div>`,
                            color: "from-purple-100 to-indigo-100",
                            darkColor: "from-purple-900/30 to-indigo-900/30",
                            icon: "üîÑ"
                        },
                        {
                            title: "‚úñÔ∏è Conversi√≥n a Multiplicaci√≥n",
                            content: `<div class="text-center text-xl mb-3">
                                <span class="fraction">
                                    <span class="numerator text-red-600">${num1}</span>
                                    <span class="denominator text-blue-600">${den1}</span>
                                </span>
                                <span class="mx-2 text-red-600 line-through">√∑</span>
                                <span class="mx-2 text-green-600 font-bold">√ó</span>
                                <span class="fraction">
                                    <span class="numerator text-blue-600">${den2}</span>
                                    <span class="denominator text-red-600">${num2}</span>
                                </span>
                            </div>
                            <p class="text-center text-sm">Cambiamos divisi√≥n por multiplicaci√≥n</p>`,
                            color: "from-green-100 to-emerald-100",
                            darkColor: "from-green-900/30 to-emerald-900/30",
                            icon: "üîÑ"
                        },
                        {
                            title: "üßÆ Multiplicaci√≥n Final",
                            content: `<div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                    <div class="text-lg font-bold text-red-600">Numerador:</div>
                                    <div class="text-xl">${num1} √ó ${den2} = <span class="font-bold text-green-600">${divNum}</span></div>
                                </div>
                                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <div class="text-lg font-bold text-blue-600">Denominador:</div>
                                    <div class="text-xl">${den1} √ó ${num2} = <span class="font-bold text-purple-600">${divDen}</span></div>
                                </div>
                            </div>`,
                            color: "from-yellow-100 to-orange-100",
                            darkColor: "from-yellow-900/30 to-orange-900/30",
                            icon: "üé™"
                        },
                        {
                            title: "üéØ Resultado de la Divisi√≥n",
                            content: `<div class="text-center">
                                <div class="fraction text-3xl mb-3">
                                    <span class="numerator text-green-600 font-bold">${result[0]}</span>
                                    <span class="denominator text-purple-600 font-bold">${result[1]}</span>
                                </div>
                                <p class="text-sm">Resultado final simplificado</p>
                            </div>`,
                            color: "from-indigo-100 to-purple-100",
                            darkColor: "from-indigo-900/30 to-purple-900/30",
                            icon: "üèÜ"
                        }
                    ];
                    break;
            }

            // Generate the final HTML with enhanced styling
            return stepsData.map((step, index) => `
                <div class="mb-6 transform hover:scale-105 transition-all duration-300">
                    <div class="bg-gradient-to-r ${step.color} dark:${step.darkColor} p-6 rounded-2xl border-l-4 border-indigo-500 shadow-lg hover:shadow-xl">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3 animate-pulse">${step.icon}</span>
                            <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200">${step.title}</h4>
                        </div>
                        <div class="text-gray-700 dark:text-gray-300">
                            ${step.content}
                        </div>
                        ${index < stepsData.length - 1 ? '<div class="flex justify-center mt-4"><div class="text-2xl text-gray-400">‚¨áÔ∏è</div></div>' : ''}
                    </div>
                </div>
            `).join('') + `
                <div class="mt-8 p-6 bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl text-white text-center transform hover:scale-105 transition-all duration-300 shadow-xl">
                    <div class="text-4xl mb-3">üéâ</div>
                    <h3 class="text-2xl font-bold mb-2">¬°Resultado Final!</h3>
                    <div class="fraction text-4xl mb-3">
                        <span class="numerator font-bold">${result[0]}</span>
                        <span class="denominator font-bold">${result[1]}</span>
                    </div>
                    <p class="text-lg">¬°Excelente trabajo resolviendo esta operaci√≥n!</p>
                </div>
            `;
        }

        // Converter Functions
        function convertFraction() {
            const num = parseInt(document.getElementById('conv-num').value);
            const den = parseInt(document.getElementById('conv-den').value);

            if (isNaN(num) || isNaN(den) || den <= 0) {
                showCustomAlert('Por favor ingresa una fracci√≥n v√°lida');
                return;
            }

            const simplified = simplifyFraction(num, den);
            const decimal = num / den;
            const percentage = (decimal * 100).toFixed(2);
            const mixed = convertToMixed(num, den);

            displayConversionResults(simplified, decimal, percentage, mixed);
            showSimplificationSteps(num, den, simplified);
        }

        function convertDecimal() {
            const decimal = parseFloat(document.getElementById('decimal-input').value);

            if (isNaN(decimal)) {
                showCustomAlert('Por favor ingresa un decimal v√°lido');
                return;
            }

            const fraction = decimalToFraction(decimal);
            const simplified = simplifyFraction(fraction[0], fraction[1]);
            const percentage = (decimal * 100).toFixed(2);
            const mixed = convertToMixed(simplified[0], simplified[1]);

            displayConversionResults(simplified, decimal, percentage, mixed);
            showSimplificationSteps(fraction[0], fraction[1], simplified);
        }

        function displayConversionResults(fraction, decimal, percentage, mixed) {
            document.getElementById('result-fraction').textContent = 
                fraction[1] === 1 ? fraction[0].toString() : `${fraction[0]}/${fraction[1]}`;
            document.getElementById('result-decimal').textContent = decimal.toFixed(4);
            document.getElementById('result-percentage').textContent = percentage + '%';
            document.getElementById('result-mixed').textContent = mixed;
        }

        function showSimplificationSteps(originalNum, originalDen, simplified) {
            if (originalNum === simplified[0] && originalDen === simplified[1]) {
                document.getElementById('simplification-steps').classList.add('hidden');
                return;
            }

            const gcd = findGCD(originalNum, originalDen);
            const steps = [
                `üìç Fracci√≥n original: ${originalNum}/${originalDen}`,
                `üîç M√°ximo Com√∫n Divisor (MCD): ${gcd}`,
                `‚ûó ${originalNum} √∑ ${gcd} = ${simplified[0]}`,
                `‚ûó ${originalDen} √∑ ${gcd} = ${simplified[1]}`,
                `‚úÖ Fracci√≥n simplificada: ${simplified[0]}/${simplified[1]}`
            ];

            document.getElementById('simplify-content').innerHTML = 
                steps.map(step => `<div class="text-sm p-2 bg-orange-50 dark:bg-orange-900/20 rounded">${step}</div>`).join('');
            document.getElementById('simplification-steps').classList.remove('hidden');
        }

        function convertToMixed(num, den) {
            if (num < den) return `${num}/${den}`;
            
            const whole = Math.floor(num / den);
            const remainder = num % den;
            
            if (remainder === 0) return whole.toString();
            return `${whole} ${remainder}/${den}`;
        }

        function decimalToFraction(decimal) {
            const tolerance = 1.0E-6;
            let h1 = 1, h2 = 0, k1 = 0, k2 = 1;
            let b = decimal;
            
            do {
                const a = Math.floor(b);
                let aux = h1; h1 = a * h1 + h2; h2 = aux;
                aux = k1; k1 = a * k1 + k2; k2 = aux;
                b = 1 / (b - a);
            } while (Math.abs(decimal - h1 / k1) > decimal * tolerance);
            
            return [h1, k1];
        }

        function findGCD(a, b) {
            return b === 0 ? a : findGCD(b, a % b);
        }

        // Generator Functions
        let generatedProblems = [];

        // Update slider display
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('num-problems');
            const display = document.getElementById('num-problems-display');
            
            if (slider && display) {
                slider.addEventListener('input', function() {
                    display.textContent = this.value;
                });
            }
        });

        function generateCustomProblems() {
            const difficulty = document.getElementById('difficulty-level').value;
            const context = document.getElementById('problem-context').value;
            const numProblems = parseInt(document.getElementById('num-problems').value);

            const operations = [];
            if (document.getElementById('gen-add').checked) operations.push('add');
            if (document.getElementById('gen-subtract').checked) operations.push('subtract');
            if (document.getElementById('gen-multiply').checked) operations.push('multiply');
            if (document.getElementById('gen-divide').checked) operations.push('divide');

            if (operations.length === 0) {
                showCustomAlert('Selecciona al menos un tipo de operaci√≥n');
                return;
            }

            generatedProblems = [];
            const maxDen = difficulty === 'easy' ? 8 : difficulty === 'medium' ? 12 : 20;

            for (let i = 0; i < numProblems; i++) {
                const operation = operations[Math.floor(Math.random() * operations.length)];
                const problem = createContextualProblem(operation, maxDen, context);
                generatedProblems.push(problem);
            }

            displayGeneratedProblems();
            document.getElementById('export-options').classList.remove('hidden');
        }

        function createContextualProblem(operation, maxDen, context) {
            const num1 = Math.floor(Math.random() * (maxDen - 1)) + 1;
            const den1 = Math.floor(Math.random() * maxDen) + 2;
            const num2 = Math.floor(Math.random() * (maxDen - 1)) + 1;
            const den2 = Math.floor(Math.random() * maxDen) + 2;

            let problem, solution;

            switch (operation) {
                case 'add':
                    problem = `${num1}/${den1} + ${num2}/${den2}`;
                    solution = simplifyFraction((num1 * den2) + (num2 * den1), den1 * den2);
                    break;
                case 'subtract':
                    if (num1 * den2 >= num2 * den1) {
                        problem = `${num1}/${den1} - ${num2}/${den2}`;
                        solution = simplifyFraction((num1 * den2) - (num2 * den1), den1 * den2);
                    } else {
                        problem = `${num2}/${den2} - ${num1}/${den1}`;
                        solution = simplifyFraction((num2 * den1) - (num1 * den2), den1 * den2);
                    }
                    break;
                case 'multiply':
                    problem = `${num1}/${den1} √ó ${num2}/${den2}`;
                    solution = simplifyFraction(num1 * num2, den1 * den2);
                    break;
                case 'divide':
                    problem = `${num1}/${den1} √∑ ${num2}/${den2}`;
                    solution = simplifyFraction(num1 * den2, den1 * num2);
                    break;
            }

            const contextual = addProblemContext(problem, context, operation);

            return {
                abstract: problem,
                contextual: contextual,
                solution: solution,
                operation: operation
            };
        }

        function addProblemContext(problem, context, operation) {
            const contexts = {
                food: {
                    add: [`Juan comi√≥ ${problem.split(' + ')[0]} de pizza y Mar√≠a comi√≥ ${problem.split(' + ')[1]} de pizza. ¬øQu√© fracci√≥n de pizza comieron en total?`],
                    subtract: [`Ten√≠a ${problem.split(' - ')[0]} de pastel y me com√≠ ${problem.split(' - ')[1]} del pastel. ¬øQu√© fracci√≥n me queda?`],
                    multiply: [`Si cada porci√≥n es ${problem.split(' √ó ')[0]} de la pizza y tengo ${problem.split(' √ó ')[1]} porciones, ¬øcu√°nta pizza tengo?`],
                    divide: [`Tengo ${problem.split(' √∑ ')[0]} de chocolate y lo quiero dividir en ${problem.split(' √∑ ')[1]} partes iguales. ¬øCu√°nto recibe cada parte?`]
                },
                time: {
                    add: [`Estudi√© ${problem.split(' + ')[0]} de hora en la ma√±ana y ${problem.split(' + ')[1]} de hora en la tarde. ¬øCu√°ntas horas estudi√© en total?`],
                    subtract: [`El viaje dura ${problem.split(' - ')[0]} de hora, pero llegu√© ${problem.split(' - ')[1]} de hora antes. ¬øCu√°nto tiempo viaj√© realmente?`],
                    multiply: [`Cada clase dura ${problem.split(' √ó ')[0]} de hora y tengo ${problem.split(' √ó ')[1]} clases. ¬øCu√°ntas horas de clase tengo?`],
                    divide: [`Tengo ${problem.split(' √∑ ')[0]} de hora para hacer la tarea y son ${problem.split(' √∑ ')[1]} ejercicios. ¬øCu√°nto tiempo dedico a cada ejercicio?`]
                },
                money: {
                    add: [`Gast√© $${problem.split(' + ')[0]} en el desayuno y $${problem.split(' + ')[1]} en el almuerzo. ¬øQu√© fracci√≥n de peso gast√©?`],
                    subtract: [`Ten√≠a $${problem.split(' - ')[0]} y gast√© $${problem.split(' - ')[1]}. ¬øQu√© fracci√≥n me queda?`],
                    multiply: [`El precio de un producto es $${problem.split(' √ó ')[0]} y compr√© ${problem.split(' √ó ')[1]} unidades. ¬øCu√°nto pagu√©?`],
                    divide: [`Tengo $${problem.split(' √∑ ')[0]} para repartir entre ${problem.split(' √∑ ')[1]} personas. ¬øCu√°nto recibe cada una?`]
                },
                distance: {
                    add: [`Camin√© ${problem.split(' + ')[0]} km por la ma√±ana y ${problem.split(' + ')[1]} km por la tarde. ¬øCu√°ntos kil√≥metros camin√© en total?`],
                    subtract: [`La ruta completa es de ${problem.split(' - ')[0]} km, pero ya recorr√≠ ${problem.split(' - ')[1]} km. ¬øCu√°nto me falta?`],
                    multiply: [`Cada vuelta es de ${problem.split(' √ó ')[0]} km y di ${problem.split(' √ó ')[1]} vueltas. ¬øCu√°ntos kil√≥metros recorr√≠?`],
                    divide: [`Tengo que recorrer ${problem.split(' √∑ ')[0]} km en ${problem.split(' √∑ ')[1]} etapas iguales. ¬øCu√°ntos kil√≥metros por etapa?`]
                }
            };

            if (context === 'abstract') return problem;
            
            const contextGroup = contexts[context];
            if (contextGroup && contextGroup[operation]) {
                return contextGroup[operation][0] + ` (${problem})`;
            }
            
            return problem;
        }

        function displayGeneratedProblems() {
            const problemsList = document.getElementById('problems-list');
            
            const problemsHTML = generatedProblems.map((problem, index) => `
                <div class="p-4 bg-gradient-to-r from-orange-50 to-yellow-50 dark:from-orange-900/20 dark:to-yellow-900/20 rounded-lg border-l-4 border-orange-500">
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-bold text-orange-600">Problema ${index + 1}</h5>
                        <span class="text-xs bg-orange-200 dark:bg-orange-800 px-2 py-1 rounded-full">${problem.operation}</span>
                    </div>
                    <p class="text-sm mb-2">${problem.contextual}</p>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        <strong>Respuesta:</strong> ${problem.solution[1] === 1 ? problem.solution[0] : `${problem.solution[0]}/${problem.solution[1]}`}
                    </div>
                </div>
            `).join('');

            problemsList.innerHTML = problemsHTML;
        }

        function copyToClipboard() {
            const text = generatedProblems.map((problem, index) => 
                `${index + 1}. ${problem.contextual}\nRespuesta: ${problem.solution[1] === 1 ? problem.solution[0] : `${problem.solution[0]}/${problem.solution[1]}`}`
            ).join('\n\n');

            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã Problemas copiados al portapapeles', 'success');
            }).catch(() => {
                showCustomAlert('No se pudo copiar al portapapeles');
            });
        }

        function downloadProblems() {
            const content = `# Problemas de Fracciones Personalizados

${generatedProblems.map((problem, index) => 
    `## Problema ${index + 1}
${problem.contextual}

**Respuesta:** ${problem.solution[1] === 1 ? problem.solution[0] : `${problem.solution[0]}/${problem.solution[1]}`}
`).join('\n')}

Generado por Fracci√≥n Quest - ${new Date().toLocaleDateString()}`;

            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `problemas-fracciones-${new Date().toISOString().split('T')[0]}.md`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('üì• Archivo descargado correctamente', 'success');
        }

        function printProblems() {
            const printWindow = window.open('', '_blank');
            const content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Problemas de Fracciones Personalizados</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .problem { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                        .answer { color: #666; font-style: italic; margin-top: 10px; }
                        @media print { .answer { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üéÆ Problemas de Fracciones Personalizados</h1>
                    <p>Fecha: ${new Date().toLocaleDateString()}</p>
                    <hr>
                    ${generatedProblems.map((problem, index) => `
                        <div class="problem">
                            <h3>Problema ${index + 1}</h3>
                            <p>${problem.contextual}</p>
                            <div class="answer">Respuesta: ${problem.solution[1] === 1 ? problem.solution[0] : `${problem.solution[0]}/${problem.solution[1]}`}</div>
                        </div>
                    `).join('')}
                </body>
                </html>
            `;
            
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function shareProblems() {
            if (navigator.share) {
                const text = generatedProblems.map((problem, index) => 
                    `${index + 1}. ${problem.contextual}`
                ).join('\n\n');

                navigator.share({
                    title: 'Problemas de Fracciones',
                    text: text
                });
            } else {
                copyToClipboard();
                showNotification('üì§ Problemas copiados para compartir', 'success');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
